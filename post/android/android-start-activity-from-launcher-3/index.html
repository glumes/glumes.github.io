<!DOCTYPE html>
<html lang="zh">
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


  <title>Android 6.0 Launcher 启动 Activity 过程源码分析（三）</title>
  <meta property="og:title" content="Android 6.0 Launcher 启动 Activity 过程源码分析（三）" />
  <meta name="twitter:title" content="Android 6.0 Launcher 启动 Activity 过程源码分析（三）" />

  <meta name="description" content="在  Android 6.0 Launcher 启动 Activity 过程源码分析（二） 分析完了对待启动 Activity 组件的验证过程，获得组件信息，以及 ActivityRecord 添加至栈顶，将其他 Activity 进入中止状态，最后将待启动的 Activity 组件进入 Resumed状态，然而，由于待启动的 Activity 组件的应用程序进程尚未启动，最后执行 startSpecificActivityLocked方法创建进程。">
  <meta property="og:description" content="在  Android 6.0 Launcher 启动 Activity 过程源码分析（二） 分析完了对待启动 Activity 组件的验证过程，获得组件信息，以及 ActivityRecord 添加至栈顶，将其他 Activity 进入中止状态，最后将待启动的 Activity 组件进入 Resumed状态，然而，由于待启动的 Activity 组件的应用程序进程尚未启动，最后执行 startSpecificActivityLocked方法创建进程。">
  <meta name="twitter:description" content="在  Android 6.0 Launcher 启动 Activity 过程源码分析（二） 分析完了对待启动 Activity 组件的验证过程，获得组件信息，以及 ActivityRecord 添加至栈顶，将其他 Activity 进入中止状态，最后将待启动的 Activity 组件进入 Resumed状态，然而，由于待启动的 Activity 组件的应用程序进程尚未启动， …">
  <meta name="author" content=""/>
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://glumes.com/post/android/android-start-activity-from-launcher-3/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="音视频开发进阶" />

  <meta name="generator" content="Hugo 0.74.3" />
  <link rel="canonical" href="https://glumes.com/post/android/android-start-activity-from-launcher-3/" />
  <link rel="alternate" href="https://glumes.com/index.xml" type="application/rss+xml" title="音视频开发进阶">

  
  

  <link rel="stylesheet" href='https://glumes.com/css/bundle.min.fb9e227ddbeead55275b2028c55c2dd4b6b4e09ded2b8c8e4dc5c8c417bc97de.css' integrity='sha256-&#43;54ifdvurVUnWyAoxVwt1La04J3tK4yOTcXIxBe8l94='>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
  
  
    
    <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <![endif]-->

<link rel="stylesheet" href="https://res.cloudinary.com/glumes-com/raw/upload/v1516330613/website/css/prism.css" />





<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?9276c0ce2d3c49b591323abab4a32e1e";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
</script>


<script async src="https://www.googletagmanager.com/gtag/js?id=G-TRLK1SYTZ1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TRLK1SYTZ1');
</script>


</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">切换导航</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://glumes.com/" title="音视频开发进阶">
        
        音视频开发进阶
      </a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">音视频开发</a>
              <div class="navlinks-children">
                
                  <a href="https://glumes.com/categories/opengl">OpenGL </a>
                
                  <a href="https://glumes.com/categories/ffmpeg">FFmpeg</a>
                
                  <a href="https://glumes.com/categories/vulkan">Vulkan </a>
                
                  <a href="https://glumes.com/categories/webrtc">WebRTC </a>
                
                  <a href="https://glumes.com/categories/opencv">opencv </a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">移动开发</a>
              <div class="navlinks-children">
                
                  <a href="https://glumes.com/categories/android">Android</a>
                
                  <a href="https://glumes.com/categories/ios">ios</a>
                
                  <a href="https://glumes.com/categories/c&#43;&#43;">C&#43;&#43;</a>
                
                  <a href="https://glumes.com/categories/python">Python</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="程序人生" href="https://glumes.com/categories/life">程序人生</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">我的视频教学</a>
              <div class="navlinks-children">
                
                  <a href="https://space.bilibili.com/105478237">B 站视频</a>
                
                  <a href="http://www.imooc.com/learn/1212">慕课网视频</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="小专栏" href="https://xiaozhuanlan.com/glumes">小专栏</a>
            </li>
          
        
          
            <li>
              <a title="关于" href="https://glumes.com/about/">关于</a>
            </li>
          
        
          
            <li>
              <a title="所有文章" href="https://glumes.com/post/">所有文章</a>
            </li>
          
        

        

        

        

      </ul>
    </div>

  </div>
</nav>


    
  
  
  




  

  <header class="header-section ">
    
    
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="post-heading">
              <h1>Android 6.0 Launcher 启动 Activity 过程源码分析（三）</h1>
                
                
                  <span class="post-meta">
  
    发表于 December 22, 2017
  
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
  </header>


    



<div class="container" role="main">
  <div class="row">

    
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div>
            
            
            <h5 id="tags" style="margin-top: 30px;">标签:
              
                  <a href="https://glumes.com/tags/android/">Android</a> &nbsp;
              
                  <a href="https://glumes.com/tags/framework/">Framework</a> &nbsp;
              
            </h5>
            
        </div>
  
        <article role="main" class="blog-post" itemprop="articleBody" id="content">
          
            
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#activitystacksupervisor-类的-startspecificactivitylocked-方法">ActivityStackSupervisor 类的 startSpecificActivityLocked() 方法</a></li>
        <li><a href="#activitymanagerservice类的-startprocesslocked-方法">ActivityManagerService类的 startProcessLocked() 方法</a></li>
        <li><a href="#activitymanagerservice类的-newprocessrecordlocked-方法">ActivityManagerService类的 newProcessRecordLocked() 方法</a></li>
        <li><a href="#activitymanagerservice类的-startprocesslocked-方法-1">ActivityManagerService类的 startProcessLocked() 方法</a></li>
        <li><a href="#activitythread-类的-main-方法">ActivityThread 类的 main() 方法</a></li>
        <li><a href="#activitymanagerservice类的-attachapplication-方法">ActivityManagerService类的 attachApplication() 方法</a></li>
        <li><a href="#activitymanagerservice类的-attachapplicationlocked-方法">ActivityManagerService类的 attachApplicationLocked() 方法</a></li>
        <li><a href="#activitythread-类的-handlebindapplication-方法">ActivityThread 类的 handleBindApplication() 方法</a></li>
        <li><a href="#stacksupervisor-类的-attachapplicationlocked-方法">StackSupervisor 类的 attachApplicationLocked() 方法</a></li>
        <li><a href="#stacksupervisor-类的-realstartactivitylocked-方法">StackSupervisor 类的 realStartActivityLocked() 方法</a></li>
        <li><a href="#activitythread-类的-handlelaunchactivity-方法">ActivityThread 类的 handleLaunchActivity() 方法</a></li>
        <li><a href="#activitythread-类的-performlaunchactivity-方法">ActivityThread 类的 performLaunchActivity() 方法</a></li>
        <li><a href="#activitythread-类的-handleresumeactivity-方法">ActivityThread 类的 handleResumeActivity() 方法</a></li>
        <li><a href="#activitythread-类的-performresumeactivity-方法">ActivityThread 类的 performResumeActivity() 方法</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav>
</aside>

          
  
          
          
          
  
          
          
          
  
          
          
          

          <p>在 <a href="http://www.glumes.com/start-activity-from-launcher-in-android-2/"> Android 6.0 Launcher 启动 Activity 过程源码分析（二）</a> 分析完了对待启动 Activity 组件的验证过程，获得组件信息，以及 ActivityRecord 添加至栈顶，将其他 Activity 进入中止状态，最后将待启动的 Activity 组件进入 <code>Resumed</code>状态，然而，由于待启动的 Activity 组件的应用程序进程尚未启动，最后执行 <code>startSpecificActivityLocked</code>方法创建进程。</p>
<h3 id="activitystacksupervisor-类的-startspecificactivitylocked-方法">ActivityStackSupervisor 类的 startSpecificActivityLocked() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">startSpecificActivityLocked</span>(<span style="color:#268bd2">ActivityRecord</span> <span style="color:#268bd2">r</span>,
            <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">andResume</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">checkConfig</span>) {
        <span style="color:#93a1a1;font-style:italic">// Is this activity&#39;s application already running?
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">app</span> = <span style="color:#268bd2">mService</span>.<span style="color:#268bd2">getProcessRecordLocked</span>(<span style="color:#268bd2">r</span>.<span style="color:#268bd2">processName</span>,
                <span style="color:#268bd2">r</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">applicationInfo</span>.<span style="color:#268bd2">uid</span>, <span style="color:#859900;font-weight:bold">true</span>);

        <span style="color:#268bd2">r</span>.<span style="color:#268bd2">task</span>.<span style="color:#268bd2">stack</span>.<span style="color:#268bd2">setLaunchTime</span>(<span style="color:#268bd2">r</span>);
		
        <span style="color:#859900">if</span> (<span style="color:#268bd2">app</span> != <span style="color:#859900;font-weight:bold">null</span> &amp;&amp; <span style="color:#268bd2">app</span>.<span style="color:#268bd2">thread</span> != <span style="color:#859900;font-weight:bold">null</span>) {
            <span style="color:#859900">try</span> {
                <span style="color:#859900">if</span> ((<span style="color:#268bd2">r</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">flags</span>&amp;<span style="color:#268bd2">ActivityInfo</span>.<span style="color:#268bd2">FLAG_MULTIPROCESS</span>) == <span style="color:#268bd2">0</span>
                        || !<span style="color:#2aa198">&#34;android&#34;</span>.<span style="color:#268bd2">equals</span>(<span style="color:#268bd2">r</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">packageName</span>)) {
                    <span style="color:#268bd2">app</span>.<span style="color:#268bd2">addPackage</span>(<span style="color:#268bd2">r</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">packageName</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">applicationInfo</span>.<span style="color:#268bd2">versionCode</span>,
                            <span style="color:#268bd2">mService</span>.<span style="color:#268bd2">mProcessStats</span>);
                }
                <span style="color:#268bd2">realStartActivityLocked</span>(<span style="color:#268bd2">r</span>, <span style="color:#268bd2">app</span>, <span style="color:#268bd2">andResume</span>, <span style="color:#268bd2">checkConfig</span>);
                <span style="color:#859900">return</span>;
            } <span style="color:#859900">catch</span> (<span style="color:#268bd2">RemoteException</span> <span style="color:#268bd2">e</span>) {
            }
        }
		<span style="color:#93a1a1;font-style:italic">// 进程尚未启动，app 为 null 。
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#268bd2">mService</span>.<span style="color:#268bd2">startProcessLocked</span>(<span style="color:#268bd2">r</span>.<span style="color:#268bd2">processName</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">applicationInfo</span>, <span style="color:#859900;font-weight:bold">true</span>, <span style="color:#268bd2">0</span>,
                <span style="color:#2aa198">&#34;activity&#34;</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>.<span style="color:#268bd2">getComponent</span>(), <span style="color:#859900;font-weight:bold">false</span>, <span style="color:#859900;font-weight:bold">false</span>, <span style="color:#859900;font-weight:bold">true</span>);
    }
</code></pre></div><p>在 ActivityManagerService 中，每一个 Activity 组件都有一个用户 ID 和一个进程名称，其中，用户 ID 是在安装该 Activity 组件时由 PackageManagerService 分配的，而进程名称则是由该 Activity 组件的 <code>android:process</code>属性来决定的。ActivityManagerService 在启动一个 Activity 组件时，首先会以它的用户 ID 和进程名称来检查系统中是否存在一个对应的应用程序进程。如果存在，就会直接通知这个应用程序进程将 Activity 组件启动起来；否则，就会先以这个用户 ID 和进程名称来创建一个应用程序进程，然后在通知这个应用程序进程将该 Activity 组件启动起来。</p>
<p>由于应用程序进程尚未启动，则 app 为 null ，mService 变量为 ActivityManagerService 。执行 <code>startProcessLocked</code>方法。</p>
<h3 id="activitymanagerservice类的-startprocesslocked-方法">ActivityManagerService类的 startProcessLocked() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#859900">final</span> <span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">startProcessLocked</span>(<span style="color:#268bd2">String</span> <span style="color:#268bd2">processName</span>, <span style="color:#268bd2">ApplicationInfo</span> <span style="color:#268bd2">info</span>,
            <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">knownToBeDead</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">intentFlags</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">hostingType</span>, <span style="color:#268bd2">ComponentName</span> <span style="color:#268bd2">hostingName</span>,
            <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">allowWhileBooting</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">isolated</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">isolatedUid</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">keepIfLarge</span>,
            <span style="color:#268bd2">String</span> <span style="color:#268bd2">abiOverride</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">entryPoint</span>, <span style="color:#268bd2">String</span>[] <span style="color:#268bd2">entryPointArgs</span>, <span style="color:#268bd2">Runnable</span> <span style="color:#268bd2">crashHandler</span>) {
        <span style="color:#859900;font-weight:bold">long</span> <span style="color:#268bd2">startTime</span> = <span style="color:#268bd2">SystemClock</span>.<span style="color:#268bd2">elapsedRealtime</span>();
        <span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">app</span>;
        <span style="color:#859900">if</span> (!<span style="color:#268bd2">isolated</span>) { <span style="color:#93a1a1;font-style:italic">// 传入的 isolated 参数为 false ，if 成立，并不是隔离的进程
</span><span style="color:#93a1a1;font-style:italic"></span>	        <span style="color:#93a1a1;font-style:italic">// 根据进程名称和用户 ID 得到应用程序进程，由于不存在，则为 null 。
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#268bd2">app</span> = <span style="color:#268bd2">getProcessRecordLocked</span>(<span style="color:#268bd2">processName</span>, <span style="color:#268bd2">info</span>.<span style="color:#268bd2">uid</span>, <span style="color:#268bd2">keepIfLarge</span>);
            <span style="color:#268bd2">checkTime</span>(<span style="color:#268bd2">startTime</span>, <span style="color:#2aa198">&#34;startProcess: after getProcessRecord&#34;</span>);
			<span style="color:#93a1a1;font-style:italic">// 省略部分代码
</span><span style="color:#93a1a1;font-style:italic"></span>        } <span style="color:#859900">else</span> {
            <span style="color:#93a1a1;font-style:italic">// If this is an isolated process, it can&#39;t re-use an existing process.
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#268bd2">app</span> = <span style="color:#859900;font-weight:bold">null</span>;
        }
		<span style="color:#93a1a1;font-style:italic">// 当进程已经被分配的 PID 时，
</span><span style="color:#93a1a1;font-style:italic"></span>		<span style="color:#859900">if</span> (<span style="color:#268bd2">app</span> != <span style="color:#859900;font-weight:bold">null</span> &amp;&amp; <span style="color:#268bd2">app</span>.<span style="color:#268bd2">pid</span> &gt; <span style="color:#268bd2">0</span>) {
		}
		<span style="color:#93a1a1;font-style:italic">// 应用程序进程不存在，创建新的进程
</span><span style="color:#93a1a1;font-style:italic"></span>		<span style="color:#859900">if</span> (<span style="color:#268bd2">app</span> == <span style="color:#859900;font-weight:bold">null</span>) {
            <span style="color:#268bd2">checkTime</span>(<span style="color:#268bd2">startTime</span>, <span style="color:#2aa198">&#34;startProcess: creating new process record&#34;</span>);
            <span style="color:#93a1a1;font-style:italic">// 创建应用程序进程
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#268bd2">app</span> = <span style="color:#268bd2">newProcessRecordLocked</span>(<span style="color:#268bd2">info</span>, <span style="color:#268bd2">processName</span>, <span style="color:#268bd2">isolated</span>, <span style="color:#268bd2">isolatedUid</span>);
            <span style="color:#859900">if</span> (<span style="color:#268bd2">app</span> == <span style="color:#859900;font-weight:bold">null</span>) {
            }
            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">crashHandler</span> = <span style="color:#268bd2">crashHandler</span>;
            <span style="color:#268bd2">checkTime</span>(<span style="color:#268bd2">startTime</span>, <span style="color:#2aa198">&#34;startProcess: done creating new process record&#34;</span>);
        } <span style="color:#859900">else</span> {
            <span style="color:#93a1a1;font-style:italic">// If this is a new package in the process, add the package to the list
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">addPackage</span>(<span style="color:#268bd2">info</span>.<span style="color:#268bd2">packageName</span>, <span style="color:#268bd2">info</span>.<span style="color:#268bd2">versionCode</span>, <span style="color:#268bd2">mProcessStats</span>);
            <span style="color:#268bd2">checkTime</span>(<span style="color:#268bd2">startTime</span>, <span style="color:#2aa198">&#34;startProcess: added package to existing proc&#34;</span>);
        }
		<span style="color:#93a1a1;font-style:italic">// 创建应用程序进程后，最终调用 startProcessLocked 方法
</span><span style="color:#93a1a1;font-style:italic"></span>		<span style="color:#268bd2">startProcessLocked</span>(
                <span style="color:#268bd2">app</span>, <span style="color:#268bd2">hostingType</span>, <span style="color:#268bd2">hostingNameStr</span>, <span style="color:#268bd2">abiOverride</span>, <span style="color:#268bd2">entryPoint</span>, <span style="color:#268bd2">entryPointArgs</span>);
</code></pre></div><p>ActivityManagerService 类的 <code>startProcessLocked</code>方法重载了多个形式，最终执行了上述的函数。</p>
<p>由于并不是隔离的进程，首先会根据进程名称和用户 ID 检查应用程序是否存在，由于不存在，app 为 null ，则创建了新的应用程序进程，通过<code>newProcessRecordLocked</code>方法。最后还是调用了 <code>startProcessLocked</code> 方法。</p>
<h3 id="activitymanagerservice类的-newprocessrecordlocked-方法">ActivityManagerService类的 newProcessRecordLocked() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#859900">final</span> <span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">newProcessRecordLocked</span>(<span style="color:#268bd2">ApplicationInfo</span> <span style="color:#268bd2">info</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">customProcess</span>,
            <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">isolated</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">isolatedUid</span>) {
        <span style="color:#268bd2">String</span> <span style="color:#268bd2">proc</span> = <span style="color:#268bd2">customProcess</span> != <span style="color:#859900;font-weight:bold">null</span> ? <span style="color:#268bd2">customProcess</span> : <span style="color:#268bd2">info</span>.<span style="color:#268bd2">processName</span>;
        <span style="color:#268bd2">BatteryStatsImpl</span> <span style="color:#268bd2">stats</span> = <span style="color:#268bd2">mBatteryStatsService</span>.<span style="color:#268bd2">getActiveStatistics</span>();
        <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">userId</span> = <span style="color:#268bd2">UserHandle</span>.<span style="color:#268bd2">getUserId</span>(<span style="color:#268bd2">info</span>.<span style="color:#268bd2">uid</span>);
        <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">uid</span> = <span style="color:#268bd2">info</span>.<span style="color:#268bd2">uid</span>;
        <span style="color:#859900">if</span> (<span style="color:#268bd2">isolated</span>) {
          <span style="color:#93a1a1;font-style:italic">// 省略与隔离进程相关代码
</span><span style="color:#93a1a1;font-style:italic"></span>        }
        <span style="color:#859900">final</span> <span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">r</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">ProcessRecord</span>(<span style="color:#268bd2">stats</span>, <span style="color:#268bd2">info</span>, <span style="color:#268bd2">proc</span>, <span style="color:#268bd2">uid</span>);
        <span style="color:#859900">if</span> (!<span style="color:#268bd2">mBooted</span> &amp;&amp; !<span style="color:#268bd2">mBooting</span>
                &amp;&amp; <span style="color:#268bd2">userId</span> == <span style="color:#268bd2">UserHandle</span>.<span style="color:#268bd2">USER_OWNER</span>
                &amp;&amp; (<span style="color:#268bd2">info</span>.<span style="color:#268bd2">flags</span> &amp; <span style="color:#268bd2">PERSISTENT_MASK</span>) == <span style="color:#268bd2">PERSISTENT_MASK</span>) {
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">persistent</span> = <span style="color:#859900;font-weight:bold">true</span>;
        }
        <span style="color:#268bd2">addProcessNameLocked</span>(<span style="color:#268bd2">r</span>);
        <span style="color:#859900">return</span> <span style="color:#268bd2">r</span>;
    }
</code></pre></div><p>通过 ApplicationInfo 创建了一个 ProcessRecord 。</p>
<h3 id="activitymanagerservice类的-startprocesslocked-方法-1">ActivityManagerService类的 startProcessLocked() 方法</h3>
<p>当创建完 ProcessRecord 后，最后还是调用了 <code>startProcessLocked</code>方法来创建一个进程 <code>Process</code> 。</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#859900">private</span> <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">startProcessLocked</span>(<span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">app</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">hostingType</span>,
            <span style="color:#268bd2">String</span> <span style="color:#268bd2">hostingNameStr</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">abiOverride</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">entryPoint</span>, <span style="color:#268bd2">String</span>[] <span style="color:#268bd2">entryPointArgs</span>) {
		<span style="color:#93a1a1;font-style:italic">// 省略部分代码
</span><span style="color:#93a1a1;font-style:italic"></span>	    <span style="color:#93a1a1;font-style:italic">// Start the process.  It will either succeed and return a result containing
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#93a1a1;font-style:italic">// the PID of the new process, or else throw a RuntimeException.
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#93a1a1;font-style:italic">// 在之前的函数调用中，entryPoint 参数为 null，则赋值为 android.app.ActivityThread 。
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">isActivityProcess</span> = (<span style="color:#268bd2">entryPoint</span> == <span style="color:#859900;font-weight:bold">null</span>);
            <span style="color:#859900">if</span> (<span style="color:#268bd2">entryPoint</span> == <span style="color:#859900;font-weight:bold">null</span>) <span style="color:#268bd2">entryPoint</span> = <span style="color:#2aa198">&#34;android.app.ActivityThread&#34;</span>;
        <span style="color:#93a1a1;font-style:italic">// 创建一个进程
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#268bd2">Process</span>.<span style="color:#268bd2">ProcessStartResult</span> <span style="color:#268bd2">startResult</span> = <span style="color:#268bd2">Process</span>.<span style="color:#268bd2">start</span>(<span style="color:#268bd2">entryPoint</span>,
                <span style="color:#268bd2">app</span>.<span style="color:#268bd2">processName</span>, <span style="color:#268bd2">uid</span>, <span style="color:#268bd2">uid</span>, <span style="color:#268bd2">gids</span>, <span style="color:#268bd2">debugFlags</span>, <span style="color:#268bd2">mountExternal</span>,
                <span style="color:#268bd2">app</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">targetSdkVersion</span>, <span style="color:#268bd2">app</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">seinfo</span>, <span style="color:#268bd2">requiredAbi</span>, <span style="color:#268bd2">instructionSet</span>,
                <span style="color:#268bd2">app</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">dataDir</span>, <span style="color:#268bd2">entryPointArgs</span>);

		<span style="color:#93a1a1;font-style:italic">// 省略部分代码
</span><span style="color:#93a1a1;font-style:italic"></span>		 <span style="color:#268bd2">app</span>.<span style="color:#268bd2">setPid</span>(<span style="color:#268bd2">startResult</span>.<span style="color:#268bd2">pid</span>);
            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">usingWrapper</span> = <span style="color:#268bd2">startResult</span>.<span style="color:#268bd2">usingWrapper</span>;
            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">removed</span> = <span style="color:#859900;font-weight:bold">false</span>;
            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">killed</span> = <span style="color:#859900;font-weight:bold">false</span>;
            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">killedByAm</span> = <span style="color:#859900;font-weight:bold">false</span>;
            <span style="color:#268bd2">checkTime</span>(<span style="color:#268bd2">startTime</span>, <span style="color:#2aa198">&#34;startProcess: starting to update pids map&#34;</span>);
            <span style="color:#859900">synchronized</span> (<span style="color:#268bd2">mPidsSelfLocked</span>) {
            <span style="color:#93a1a1;font-style:italic">// app 类型为 ProcessRecord
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#93a1a1;font-style:italic">// 将 ProcessRecord 对象保存在 ActivityManagerService 类的成员变量 mPidsSelfLocked 中
</span><span style="color:#93a1a1;font-style:italic"></span>                <span style="color:#859900">this</span>.<span style="color:#268bd2">mPidsSelfLocked</span>.<span style="color:#268bd2">put</span>(<span style="color:#268bd2">startResult</span>.<span style="color:#268bd2">pid</span>, <span style="color:#268bd2">app</span>);
                <span style="color:#859900">if</span> (<span style="color:#268bd2">isActivityProcess</span>) {
                <span style="color:#93a1a1;font-style:italic">// 向 ActivityManagerService 所运行的线程的消息队列发送 PROC_START_TIMEOUT_MSG 类型的消息
</span><span style="color:#93a1a1;font-style:italic"></span>                <span style="color:#93a1a1;font-style:italic">// 并指定这个消息在 PROC_START_TIMEOUT 毫秒后处理
</span><span style="color:#93a1a1;font-style:italic"></span>                    <span style="color:#268bd2">Message</span> <span style="color:#268bd2">msg</span> = <span style="color:#268bd2">mHandler</span>.<span style="color:#268bd2">obtainMessage</span>(<span style="color:#268bd2">PROC_START_TIMEOUT_MSG</span>);
                    <span style="color:#268bd2">msg</span>.<span style="color:#268bd2">obj</span> = <span style="color:#268bd2">app</span>;
                    <span style="color:#268bd2">mHandler</span>.<span style="color:#268bd2">sendMessageDelayed</span>(<span style="color:#268bd2">msg</span>, <span style="color:#268bd2">startResult</span>.<span style="color:#268bd2">usingWrapper</span>
                            ? <span style="color:#268bd2">PROC_START_TIMEOUT_WITH_WRAPPER</span> : <span style="color:#268bd2">PROC_START_TIMEOUT</span>);
                }
            }
}
</code></pre></div><p>调用 Process 类的静态成员函数<code>start</code>来启动一个新的应用程序进程。</p>
<p>新的应用程序进程创建完成后，当前进程就会得到一个大于 0 的进程 ID ，保存在变量 <code>pid</code>中，接着就以变量 <code>pid</code>为关键字将参数 app 所指向的一个 ProcessRecord 对象保存在 ActivityManagerService 类的成员变量 <code>mPidsSelfLocked</code>中。</p>
<p>最后，当新的进程启动完后，还需要向 ActivityManagerService 发送一个通知，以便 ActivityManagerService 可以在它里面启动一个 Service 组件，否则，ActivityManagerService 会认为它超时了，因此，不能将 Activity 组件启动起来。</p>
<h3 id="activitythread-类的-main-方法">ActivityThread 类的 main() 方法</h3>
<p>由于 Process 类的静态方法 start 的第一个参数指明了进程进入点，则 ActivityThread 的 main 方法为一个进程的开始点。</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#859900">public</span> <span style="color:#859900">final</span> <span style="color:#859900">class</span> <span style="color:#cb4b16">ActivityThread</span> {
   <span style="color:#859900">final</span> <span style="color:#268bd2">ApplicationThread</span> <span style="color:#268bd2">mAppThread</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">ApplicationThread</span>();
   <span style="color:#859900">public</span> <span style="color:#859900">static</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">main</span>(<span style="color:#268bd2">String</span>[] <span style="color:#268bd2">args</span>) {
	   <span style="color:#93a1a1;font-style:italic">// 初始化主线程的消息队列
</span><span style="color:#93a1a1;font-style:italic"></span>	   <span style="color:#268bd2">Looper</span>.<span style="color:#268bd2">prepareMainLooper</span>();
       <span style="color:#268bd2">ActivityThread</span> <span style="color:#268bd2">thread</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">ActivityThread</span>();
       <span style="color:#268bd2">thread</span>.<span style="color:#268bd2">attach</span>(<span style="color:#859900;font-weight:bold">false</span>);
	
	   <span style="color:#859900">if</span> (<span style="color:#268bd2">sMainThreadHandler</span> == <span style="color:#859900;font-weight:bold">null</span>) {
            <span style="color:#268bd2">sMainThreadHandler</span> = <span style="color:#268bd2">thread</span>.<span style="color:#268bd2">getHandler</span>();
       }
       <span style="color:#93a1a1;font-style:italic">// 开启消息循环
</span><span style="color:#93a1a1;font-style:italic"></span>       <span style="color:#268bd2">Looper</span>.<span style="color:#268bd2">loop</span>();
   }
   
   <span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">attach</span>(<span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">system</span>) {
        <span style="color:#268bd2">sCurrentActivityThread</span> = <span style="color:#859900">this</span>;
        <span style="color:#268bd2">mSystemThread</span> = <span style="color:#268bd2">system</span>;
        <span style="color:#859900">if</span> (!<span style="color:#268bd2">system</span>) { <span style="color:#93a1a1;font-style:italic">// 是否为系统进程
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#268bd2">android</span>.<span style="color:#268bd2">ddm</span>.<span style="color:#268bd2">DdmHandleAppName</span>.<span style="color:#268bd2">setAppName</span>(<span style="color:#2aa198">&#34;&lt;pre-initialized&gt;&#34;</span>,
                                                    <span style="color:#268bd2">UserHandle</span>.<span style="color:#268bd2">myUserId</span>());
            <span style="color:#268bd2">RuntimeInit</span>.<span style="color:#268bd2">setApplicationObject</span>(<span style="color:#268bd2">mAppThread</span>.<span style="color:#268bd2">asBinder</span>());
            <span style="color:#93a1a1;font-style:italic">// 获得 ActivityManagerService 的代理对象
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#859900">final</span> <span style="color:#268bd2">IActivityManager</span> <span style="color:#268bd2">mgr</span> = <span style="color:#268bd2">ActivityManagerNative</span>.<span style="color:#268bd2">getDefault</span>();
            <span style="color:#859900">try</span> {
                <span style="color:#268bd2">mgr</span>.<span style="color:#268bd2">attachApplication</span>(<span style="color:#268bd2">mAppThread</span>);
            } <span style="color:#859900">catch</span> (<span style="color:#268bd2">RemoteException</span> <span style="color:#268bd2">ex</span>) {
                <span style="color:#93a1a1;font-style:italic">// Ignore
</span><span style="color:#93a1a1;font-style:italic"></span>            }
     
        } <span style="color:#859900">else</span> {
		   <span style="color:#93a1a1;font-style:italic">// 省略系统进程代码
</span><span style="color:#93a1a1;font-style:italic"></span>        } 
		<span style="color:#93a1a1;font-style:italic">// 省略 ViewRootImpl 相关代码
</span><span style="color:#93a1a1;font-style:italic"></span>    }
}

<span style="color:#93a1a1;font-style:italic">// ActivityManagerProxy 的 attachApplication 方法
</span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#859900">public</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">attachApplication</span>(<span style="color:#268bd2">IApplicationThread</span> <span style="color:#268bd2">app</span>) <span style="color:#859900">throws</span> <span style="color:#268bd2">RemoteException</span>
    {
        <span style="color:#268bd2">Parcel</span> <span style="color:#268bd2">data</span> = <span style="color:#268bd2">Parcel</span>.<span style="color:#268bd2">obtain</span>();
        <span style="color:#268bd2">Parcel</span> <span style="color:#268bd2">reply</span> = <span style="color:#268bd2">Parcel</span>.<span style="color:#268bd2">obtain</span>();
        <span style="color:#268bd2">data</span>.<span style="color:#268bd2">writeInterfaceToken</span>(<span style="color:#268bd2">IActivityManager</span>.<span style="color:#268bd2">descriptor</span>);
        <span style="color:#268bd2">data</span>.<span style="color:#268bd2">writeStrongBinder</span>(<span style="color:#268bd2">app</span>.<span style="color:#268bd2">asBinder</span>());
        <span style="color:#268bd2">mRemote</span>.<span style="color:#268bd2">transact</span>(<span style="color:#268bd2">ATTACH_APPLICATION_TRANSACTION</span>, <span style="color:#268bd2">data</span>, <span style="color:#268bd2">reply</span>, <span style="color:#268bd2">0</span>);
        <span style="color:#268bd2">reply</span>.<span style="color:#268bd2">readException</span>();
        <span style="color:#268bd2">data</span>.<span style="color:#268bd2">recycle</span>();
        <span style="color:#268bd2">reply</span>.<span style="color:#268bd2">recycle</span>();
    }
</code></pre></div><p>新的应用程序启动时，在 main 方法里主要做了两件事情：</p>
<ul>
<li>在新的进程里面创建一个 ActivityThread 对象，并且调用它的成员函数 attach 向 ActivityManagerService 发送一个启动完成通知。</li>
<li>调用 Looper 类的静态成员函数<code>prepareMainLooper</code>创建一个消息循环，并且在向 ActivityManagerService 发送启动完成通知之后，使得当前进程进入到这个消息循环中。</li>
</ul>
<p>在 ActivityThread 对象内还创建了一个 ApplicationThread 对象，在之前提到过 ApplicationThread 是一个 Binder 本地对象，ActivityManagerService 就是通过它来和应用程序通信的。</p>
<p>在 <code>attach</code>方法内部通过 <code>ActivityManagerNative.getDefault()</code>得到了 ActivityManagerService 的代理对象 <code>ActivityManagerProxy</code>。<code>ActivityManagerProxy</code>通过 Binder 驱动发起一个类型为 <code>ATTACH_APPLICATION_TRANSACTION</code>的进程间通信。接下来就是 ActivityManagerService 响应这个通信。</p>
<h3 id="activitymanagerservice类的-attachapplication-方法">ActivityManagerService类的 attachApplication() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#859900">public</span> <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">attachApplication</span>(<span style="color:#268bd2">IApplicationThread</span> <span style="color:#268bd2">thread</span>) {
        <span style="color:#859900">synchronized</span> (<span style="color:#859900">this</span>) {
            <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">callingPid</span> = <span style="color:#268bd2">Binder</span>.<span style="color:#268bd2">getCallingPid</span>();
            <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">long</span> <span style="color:#268bd2">origId</span> = <span style="color:#268bd2">Binder</span>.<span style="color:#268bd2">clearCallingIdentity</span>();
            <span style="color:#268bd2">attachApplicationLocked</span>(<span style="color:#268bd2">thread</span>, <span style="color:#268bd2">callingPid</span>);
            <span style="color:#268bd2">Binder</span>.<span style="color:#268bd2">restoreCallingIdentity</span>(<span style="color:#268bd2">origId</span>);
        }
    }
</code></pre></div><p>接下来执行 <code>attachApplicationLocked</code>方法。</p>
<h3 id="activitymanagerservice类的-attachapplicationlocked-方法">ActivityManagerService类的 attachApplicationLocked() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#859900">private</span> <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">attachApplicationLocked</span>(<span style="color:#268bd2">IApplicationThread</span> <span style="color:#268bd2">thread</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">pid</span>) {
		<span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">app</span>;
        <span style="color:#859900">if</span> (<span style="color:#268bd2">pid</span> != <span style="color:#268bd2">MY_PID</span> &amp;&amp; <span style="color:#268bd2">pid</span> &gt;= <span style="color:#268bd2">0</span>) {
            <span style="color:#859900">synchronized</span> (<span style="color:#268bd2">mPidsSelfLocked</span>) {
                <span style="color:#268bd2">app</span> = <span style="color:#268bd2">mPidsSelfLocked</span>.<span style="color:#268bd2">get</span>(<span style="color:#268bd2">pid</span>);
            }
        } <span style="color:#859900">else</span> {
            <span style="color:#268bd2">app</span> = <span style="color:#859900;font-weight:bold">null</span>;
        }

	   <span style="color:#859900">final</span> <span style="color:#268bd2">String</span> <span style="color:#268bd2">processName</span> = <span style="color:#268bd2">app</span>.<span style="color:#268bd2">processName</span>;
	   <span style="color:#859900">try</span> {
            <span style="color:#268bd2">AppDeathRecipient</span> <span style="color:#268bd2">adr</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">AppDeathRecipient</span>(
                    <span style="color:#268bd2">app</span>, <span style="color:#268bd2">pid</span>, <span style="color:#268bd2">thread</span>);
            <span style="color:#268bd2">thread</span>.<span style="color:#268bd2">asBinder</span>().<span style="color:#268bd2">linkToDeath</span>(<span style="color:#268bd2">adr</span>, <span style="color:#268bd2">0</span>);
            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">deathRecipient</span> = <span style="color:#268bd2">adr</span>;
        } <span style="color:#859900">catch</span> (<span style="color:#268bd2">RemoteException</span> <span style="color:#268bd2">e</span>) {
            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">resetPackageList</span>(<span style="color:#268bd2">mProcessStats</span>);
            <span style="color:#268bd2">startProcessLocked</span>(<span style="color:#268bd2">app</span>, <span style="color:#2aa198">&#34;link fail&#34;</span>, <span style="color:#268bd2">processName</span>);
            <span style="color:#859900">return</span> <span style="color:#859900;font-weight:bold">false</span>;
        }
		<span style="color:#268bd2">app</span>.<span style="color:#268bd2">makeActive</span>(<span style="color:#268bd2">thread</span>, <span style="color:#268bd2">mProcessStats</span>);
        <span style="color:#268bd2">app</span>.<span style="color:#268bd2">curAdj</span> = <span style="color:#268bd2">app</span>.<span style="color:#268bd2">setAdj</span> = -<span style="color:#268bd2">100</span>;
        <span style="color:#268bd2">app</span>.<span style="color:#268bd2">curSchedGroup</span> = <span style="color:#268bd2">app</span>.<span style="color:#268bd2">setSchedGroup</span> = <span style="color:#268bd2">Process</span>.<span style="color:#268bd2">THREAD_GROUP_DEFAULT</span>;
        <span style="color:#268bd2">app</span>.<span style="color:#268bd2">forcingToForeground</span> = <span style="color:#859900;font-weight:bold">null</span>;
        <span style="color:#268bd2">updateProcessForegroundLocked</span>(<span style="color:#268bd2">app</span>, <span style="color:#859900;font-weight:bold">false</span>, <span style="color:#859900;font-weight:bold">false</span>);
        <span style="color:#268bd2">app</span>.<span style="color:#268bd2">hasShownUi</span> = <span style="color:#859900;font-weight:bold">false</span>;
        <span style="color:#268bd2">app</span>.<span style="color:#268bd2">debugging</span> = <span style="color:#859900;font-weight:bold">false</span>;
        <span style="color:#268bd2">app</span>.<span style="color:#268bd2">cached</span> = <span style="color:#859900;font-weight:bold">false</span>;
        <span style="color:#268bd2">app</span>.<span style="color:#268bd2">killedByAm</span> = <span style="color:#859900;font-weight:bold">false</span>;
		
		<span style="color:#93a1a1;font-style:italic">// 移除超时消息，应用程序在规定时间内完成了启动。
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#268bd2">mHandler</span>.<span style="color:#268bd2">removeMessages</span>(<span style="color:#268bd2">PROC_START_TIMEOUT_MSG</span>, <span style="color:#268bd2">app</span>);

		<span style="color:#859900">try</span>{
		<span style="color:#93a1a1;font-style:italic">// 省略部分代码，跨进程调用 ActivityThread 的方法
</span><span style="color:#93a1a1;font-style:italic"></span>			<span style="color:#268bd2">thread</span>.<span style="color:#268bd2">bindApplication</span>(<span style="color:#268bd2">processName</span>, <span style="color:#268bd2">appInfo</span>, <span style="color:#268bd2">providers</span>, <span style="color:#268bd2">app</span>.<span style="color:#268bd2">instrumentationClass</span>,
                    <span style="color:#268bd2">profilerInfo</span>, <span style="color:#268bd2">app</span>.<span style="color:#268bd2">instrumentationArguments</span>, <span style="color:#268bd2">app</span>.<span style="color:#268bd2">instrumentationWatcher</span>,
                    <span style="color:#268bd2">app</span>.<span style="color:#268bd2">instrumentationUiAutomationConnection</span>, <span style="color:#268bd2">testMode</span>, <span style="color:#268bd2">enableOpenGlTrace</span>,
                    <span style="color:#268bd2">enableTrackAllocation</span>, <span style="color:#268bd2">isRestrictedBackupMode</span> || !<span style="color:#268bd2">normalMode</span>, <span style="color:#268bd2">app</span>.<span style="color:#268bd2">persistent</span>,
                    <span style="color:#859900">new</span> <span style="color:#268bd2">Configuration</span>(<span style="color:#268bd2">mConfiguration</span>), <span style="color:#268bd2">app</span>.<span style="color:#268bd2">compat</span>,
                    <span style="color:#268bd2">getCommonServicesLocked</span>(<span style="color:#268bd2">app</span>.<span style="color:#268bd2">isolated</span>),
                    <span style="color:#268bd2">mCoreSettingsObserver</span>.<span style="color:#268bd2">getCoreSettingsLocked</span>());
		}<span style="color:#859900">catch</span>(<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>){
			<span style="color:#93a1a1;font-style:italic">// 
</span><span style="color:#93a1a1;font-style:italic"></span>		}
		<span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">badApp</span> = <span style="color:#859900;font-weight:bold">false</span>;
        <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">didSomething</span> = <span style="color:#859900;font-weight:bold">false</span>;
		
		 <span style="color:#93a1a1;font-style:italic">// See if the top visible activity is waiting to run in this process...
</span><span style="color:#93a1a1;font-style:italic"></span>		 <span style="color:#93a1a1;font-style:italic">// 调度 Activity
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#859900">if</span> (<span style="color:#268bd2">normalMode</span>) {
            <span style="color:#859900">try</span> {
                <span style="color:#859900">if</span> (<span style="color:#268bd2">mStackSupervisor</span>.<span style="color:#268bd2">attachApplicationLocked</span>(<span style="color:#268bd2">app</span>)) {
                    <span style="color:#268bd2">didSomething</span> = <span style="color:#859900;font-weight:bold">true</span>;
                }
            } <span style="color:#859900">catch</span> (<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>) {
                <span style="color:#268bd2">badApp</span> = <span style="color:#859900;font-weight:bold">true</span>;
            }
        }
		<span style="color:#93a1a1;font-style:italic">// Find any services that should be running in this process...
</span><span style="color:#93a1a1;font-style:italic"></span>		<span style="color:#93a1a1;font-style:italic">// 调度 Service
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#859900">if</span> (!<span style="color:#268bd2">badApp</span>) {
            <span style="color:#859900">try</span> {
                <span style="color:#268bd2">didSomething</span> |= <span style="color:#268bd2">mServices</span>.<span style="color:#268bd2">attachApplicationLocked</span>(<span style="color:#268bd2">app</span>, <span style="color:#268bd2">processName</span>);
            } <span style="color:#859900">catch</span> (<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>) {
                <span style="color:#268bd2">badApp</span> = <span style="color:#859900;font-weight:bold">true</span>;
            }
        }
        <span style="color:#93a1a1;font-style:italic">// Check if a next-broadcast receiver is in this process...
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#93a1a1;font-style:italic">// 调度 Broadcast 
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#859900">if</span> (!<span style="color:#268bd2">badApp</span> &amp;&amp; <span style="color:#268bd2">isPendingBroadcastProcessLocked</span>(<span style="color:#268bd2">pid</span>)) {
            <span style="color:#859900">try</span> {
                <span style="color:#268bd2">didSomething</span> |= <span style="color:#268bd2">sendPendingBroadcastsLocked</span>(<span style="color:#268bd2">app</span>);
            } <span style="color:#859900">catch</span> (<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>) {
                <span style="color:#93a1a1;font-style:italic">// If the app died trying to launch the receiver we declare it &#39;bad&#39;
</span><span style="color:#93a1a1;font-style:italic"></span>                <span style="color:#268bd2">badApp</span> = <span style="color:#859900;font-weight:bold">true</span>;
            }
        }


}

<span style="color:#93a1a1;font-style:italic">// ApplicationThread 的 bindApplication 方法
</span><span style="color:#93a1a1;font-style:italic"></span><span style="color:#859900">public</span> <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">bindApplication</span>(<span style="color:#268bd2">String</span> <span style="color:#268bd2">processName</span>, <span style="color:#268bd2">ApplicationInfo</span> <span style="color:#268bd2">appInfo</span>,
                <span style="color:#268bd2">List</span>&lt;<span style="color:#268bd2">ProviderInfo</span>&gt; <span style="color:#268bd2">providers</span>, <span style="color:#268bd2">ComponentName</span> <span style="color:#268bd2">instrumentationName</span>,
                <span style="color:#268bd2">ProfilerInfo</span> <span style="color:#268bd2">profilerInfo</span>, <span style="color:#268bd2">Bundle</span> <span style="color:#268bd2">instrumentationArgs</span>,
                <span style="color:#268bd2">IInstrumentationWatcher</span> <span style="color:#268bd2">instrumentationWatcher</span>,
                <span style="color:#268bd2">IUiAutomationConnection</span> <span style="color:#268bd2">instrumentationUiConnection</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">debugMode</span>,
                <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">enableOpenGlTrace</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">trackAllocation</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">isRestrictedBackupMode</span>,
                <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">persistent</span>, <span style="color:#268bd2">Configuration</span> <span style="color:#268bd2">config</span>, <span style="color:#268bd2">CompatibilityInfo</span> <span style="color:#268bd2">compatInfo</span>,
                <span style="color:#268bd2">Map</span>&lt;<span style="color:#268bd2">String</span>, <span style="color:#268bd2">IBinder</span>&gt; <span style="color:#268bd2">services</span>, <span style="color:#268bd2">Bundle</span> <span style="color:#268bd2">coreSettings</span>) {

            <span style="color:#859900">if</span> (<span style="color:#268bd2">services</span> != <span style="color:#859900;font-weight:bold">null</span>) {
                <span style="color:#93a1a1;font-style:italic">// Setup the service cache in the ServiceManager
</span><span style="color:#93a1a1;font-style:italic"></span>                <span style="color:#268bd2">ServiceManager</span>.<span style="color:#268bd2">initServiceCache</span>(<span style="color:#268bd2">services</span>);
            }
            <span style="color:#268bd2">setCoreSettings</span>(<span style="color:#268bd2">coreSettings</span>);
            <span style="color:#268bd2">AppBindData</span> <span style="color:#268bd2">data</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">AppBindData</span>();
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">processName</span> = <span style="color:#268bd2">processName</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">appInfo</span> = <span style="color:#268bd2">appInfo</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">providers</span> = <span style="color:#268bd2">providers</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationName</span> = <span style="color:#268bd2">instrumentationName</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationArgs</span> = <span style="color:#268bd2">instrumentationArgs</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationWatcher</span> = <span style="color:#268bd2">instrumentationWatcher</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationUiAutomationConnection</span> = <span style="color:#268bd2">instrumentationUiConnection</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">debugMode</span> = <span style="color:#268bd2">debugMode</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">enableOpenGlTrace</span> = <span style="color:#268bd2">enableOpenGlTrace</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">trackAllocation</span> = <span style="color:#268bd2">trackAllocation</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">restrictedBackupMode</span> = <span style="color:#268bd2">isRestrictedBackupMode</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">persistent</span> = <span style="color:#268bd2">persistent</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">config</span> = <span style="color:#268bd2">config</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">compatInfo</span> = <span style="color:#268bd2">compatInfo</span>;
            <span style="color:#268bd2">data</span>.<span style="color:#268bd2">initProfilerInfo</span> = <span style="color:#268bd2">profilerInfo</span>;
            <span style="color:#93a1a1;font-style:italic">// 向 ActivityThread 的应用程序主进程发送消息
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#268bd2">sendMessage</span>(<span style="color:#268bd2">H</span>.<span style="color:#268bd2">BIND_APPLICATION</span>, <span style="color:#268bd2">data</span>);
        }

</code></pre></div><p>方法的参数 <code>pid</code>指向了前面所创建的应用程序进程的 PID ，在之前的步骤中，ActivityManagerService 以 PID 为关键字将一个 ProcessRecord 对象保存在了成员变量 <code>mPidsSelfLocked</code> 中，因此又通过该 PID 将 ProcessRecord 对象取回，保存在 app 变量中。</p>
<p>然后就对 app 变量进程赋值初始化，最重要的就是将应用程序进程的 ApplicationThread 对象赋值给 ProcessThread 的 <code>thread</code> 成员变量，这样 ActivityManagerService 就可以通过这个 ApplicationThread 代理对象和新创建的应用程序进程进行通信了。</p>
<p>接下来会执行 thread 的 <code>bindApplication</code>方法，该方法是一个跨进程通信了，因为 thread 是 ApplicationThread 类型。ActivityManagerService 正是通过它与 Activity 组件通信的。该方法的作用主要是将应用程序的一些信息发送给 Activity ，例如：<code>ProfilerInfo</code>之类的。</p>
<p>而<code>ApplicationThread</code>内也响应了该方法，通过解析封装相应的数据，向主线程发送一个类型为<code>BIND_APPLICATION</code>的消息。</p>
<p>而在<code>ActivityThread</code>中也有一个类型为 <code>H</code>的 Handler ，继承自 Handler，用来处理主线程的消息循环。在 <code>H</code>类的<code>handleMessage</code>中通过<code>handleBindApplication</code>方法处理了类型为<code>BIND_APPLICATION</code>的消息。</p>
<p>当 <code>ActivityManagerService</code> 的信息传递给 ActivityThread 后，就可以开始调度了 Activity 组件了。通过 <code>attachApplicationLocked</code>方法调度 Activity 。</p>
<h3 id="activitythread-类的-handlebindapplication-方法">ActivityThread 类的 handleBindApplication() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">handleBindApplication</span>(<span style="color:#268bd2">AppBindData</span> <span style="color:#268bd2">data</span>) {

	<span style="color:#93a1a1;font-style:italic">// send up app name; do this *before* waiting for debugger
</span><span style="color:#93a1a1;font-style:italic"></span>	<span style="color:#93a1a1;font-style:italic">// 设置进程名
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#268bd2">Process</span>.<span style="color:#268bd2">setArgV0</span>(<span style="color:#268bd2">data</span>.<span style="color:#268bd2">processName</span>);
    <span style="color:#93a1a1;font-style:italic">// 创建 Android 运行环境 Context .
</span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#859900">final</span> <span style="color:#268bd2">ContextImpl</span> <span style="color:#268bd2">appContext</span> = <span style="color:#268bd2">ContextImpl</span>.<span style="color:#268bd2">createAppContext</span>(<span style="color:#859900">this</span>, <span style="color:#268bd2">data</span>.<span style="color:#268bd2">info</span>);

	<span style="color:#93a1a1;font-style:italic">// 初始化 Intrumentation 对象
</span><span style="color:#93a1a1;font-style:italic"></span>	<span style="color:#859900">if</span> (<span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationName</span> != <span style="color:#859900;font-weight:bold">null</span>) {
		<span style="color:#859900">try</span> {
	       <span style="color:#268bd2">java</span>.<span style="color:#268bd2">lang</span>.<span style="color:#268bd2">ClassLoader</span> <span style="color:#268bd2">cl</span> = <span style="color:#268bd2">instrContext</span>.<span style="color:#268bd2">getClassLoader</span>();
	       <span style="color:#268bd2">mInstrumentation</span> = (<span style="color:#268bd2">Instrumentation</span>)
	                    <span style="color:#268bd2">cl</span>.<span style="color:#268bd2">loadClass</span>(<span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationName</span>.<span style="color:#268bd2">getClassName</span>()).<span style="color:#268bd2">newInstance</span>();
	       } <span style="color:#859900">catch</span> (<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>) {
	       }
	       <span style="color:#268bd2">mInstrumentation</span>.<span style="color:#268bd2">init</span>(<span style="color:#859900">this</span>, <span style="color:#268bd2">instrContext</span>, <span style="color:#268bd2">appContext</span>,
                   <span style="color:#859900">new</span> <span style="color:#268bd2">ComponentName</span>(<span style="color:#268bd2">ii</span>.<span style="color:#268bd2">packageName</span>, <span style="color:#268bd2">ii</span>.<span style="color:#268bd2">name</span>), <span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationWatcher</span>,
                   <span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationUiAutomationConnection</span>);
	 } <span style="color:#859900">else</span> {
            <span style="color:#268bd2">mInstrumentation</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">Instrumentation</span>();
     }

	 <span style="color:#93a1a1;font-style:italic">// Allow disk access during application and provider setup. This could
</span><span style="color:#93a1a1;font-style:italic"></span>     <span style="color:#93a1a1;font-style:italic">// block processing ordered broadcasts, but later processing would
</span><span style="color:#93a1a1;font-style:italic"></span>     <span style="color:#93a1a1;font-style:italic">// probably end up doing the same disk access.
</span><span style="color:#93a1a1;font-style:italic"></span> 
        <span style="color:#859900">try</span> {
            <span style="color:#93a1a1;font-style:italic">// If the app is being launched for full backup or restore, bring it up in
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#93a1a1;font-style:italic">// a restricted environment with the base application class.
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#93a1a1;font-style:italic">// 创建 Application 对象
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#268bd2">Application</span> <span style="color:#268bd2">app</span> = <span style="color:#268bd2">data</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">makeApplication</span>(<span style="color:#268bd2">data</span>.<span style="color:#268bd2">restrictedBackupMode</span>, <span style="color:#859900;font-weight:bold">null</span>);
            <span style="color:#268bd2">mInitialApplication</span> = <span style="color:#268bd2">app</span>;

            <span style="color:#93a1a1;font-style:italic">// don&#39;t bring up providers in restricted mode; they may depend on the
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#93a1a1;font-style:italic">// app&#39;s custom Application class
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#859900">if</span> (!<span style="color:#268bd2">data</span>.<span style="color:#268bd2">restrictedBackupMode</span>) {
                <span style="color:#268bd2">List</span>&lt;<span style="color:#268bd2">ProviderInfo</span>&gt; <span style="color:#268bd2">providers</span> = <span style="color:#268bd2">data</span>.<span style="color:#268bd2">providers</span>;
                <span style="color:#859900">if</span> (<span style="color:#268bd2">providers</span> != <span style="color:#859900;font-weight:bold">null</span>) {
                    <span style="color:#268bd2">installContentProviders</span>(<span style="color:#268bd2">app</span>, <span style="color:#268bd2">providers</span>);
                    <span style="color:#93a1a1;font-style:italic">// For process that contains content providers, we want to
</span><span style="color:#93a1a1;font-style:italic"></span>                    <span style="color:#93a1a1;font-style:italic">// ensure that the JIT is enabled &#34;at some point&#34;.
</span><span style="color:#93a1a1;font-style:italic"></span>                    <span style="color:#268bd2">mH</span>.<span style="color:#268bd2">sendEmptyMessageDelayed</span>(<span style="color:#268bd2">H</span>.<span style="color:#268bd2">ENABLE_JIT</span>, <span style="color:#268bd2">10</span>*<span style="color:#268bd2">1000</span>);
                }
            }

            <span style="color:#93a1a1;font-style:italic">// Do this after providers, since instrumentation tests generally start their
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#93a1a1;font-style:italic">// test thread at this point, and we don&#39;t want that racing.
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#859900">try</span> {
                <span style="color:#268bd2">mInstrumentation</span>.<span style="color:#268bd2">onCreate</span>(<span style="color:#268bd2">data</span>.<span style="color:#268bd2">instrumentationArgs</span>);
            }
            <span style="color:#859900">catch</span> (<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>) {         
            }
            <span style="color:#859900">try</span> {
            <span style="color:#93a1a1;font-style:italic">// 执行 Application 的 onCreate 方法
</span><span style="color:#93a1a1;font-style:italic"></span>                <span style="color:#268bd2">mInstrumentation</span>.<span style="color:#268bd2">callApplicationOnCreate</span>(<span style="color:#268bd2">app</span>);
            } <span style="color:#859900">catch</span> (<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>) {
            }
        } <span style="color:#859900">finally</span> {
        }
}
</code></pre></div><p>系统进程将很多与应用程序进程相关的信息传递至此进行绑定，就是为了初始化一个 Android 应用程序的运行信息。</p>
<ul>
<li>初始化了运行环境上下文 Context 。</li>
<li>初始化了 Instrumentation 。</li>
<li>初始化了 Application 类。</li>
<li>调用了 Application 的 onCreate 方法。</li>
</ul>
<p>当把这些信息传递给 Activity 组件，并且初始化结束后，新的一个进程就蜕变成了 Android 进程了。</p>
<h3 id="stacksupervisor-类的-attachapplicationlocked-方法">StackSupervisor 类的 attachApplicationLocked() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">attachApplicationLocked</span>(<span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">app</span>) <span style="color:#859900">throws</span> <span style="color:#268bd2">RemoteException</span> {
        <span style="color:#859900">final</span> <span style="color:#268bd2">String</span> <span style="color:#268bd2">processName</span> = <span style="color:#268bd2">app</span>.<span style="color:#268bd2">processName</span>;
        <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">didSomething</span> = <span style="color:#859900;font-weight:bold">false</span>;
        <span style="color:#859900">for</span> (<span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">displayNdx</span> = <span style="color:#268bd2">mActivityDisplays</span>.<span style="color:#268bd2">size</span>() - <span style="color:#268bd2">1</span>; <span style="color:#268bd2">displayNdx</span> &gt;= <span style="color:#268bd2">0</span>; --<span style="color:#268bd2">displayNdx</span>) {
            <span style="color:#268bd2">ArrayList</span>&lt;<span style="color:#268bd2">ActivityStack</span>&gt; <span style="color:#268bd2">stacks</span> = <span style="color:#268bd2">mActivityDisplays</span>.<span style="color:#268bd2">valueAt</span>(<span style="color:#268bd2">displayNdx</span>).<span style="color:#268bd2">mStacks</span>;
            <span style="color:#859900">for</span> (<span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">stackNdx</span> = <span style="color:#268bd2">stacks</span>.<span style="color:#268bd2">size</span>() - <span style="color:#268bd2">1</span>; <span style="color:#268bd2">stackNdx</span> &gt;= <span style="color:#268bd2">0</span>; --<span style="color:#268bd2">stackNdx</span>) {
                <span style="color:#859900">final</span> <span style="color:#268bd2">ActivityStack</span> <span style="color:#268bd2">stack</span> = <span style="color:#268bd2">stacks</span>.<span style="color:#268bd2">get</span>(<span style="color:#268bd2">stackNdx</span>);
                <span style="color:#859900">if</span> (!<span style="color:#268bd2">isFrontStack</span>(<span style="color:#268bd2">stack</span>)) {
                    <span style="color:#859900">continue</span>;
                }
                <span style="color:#268bd2">ActivityRecord</span> <span style="color:#268bd2">hr</span> = <span style="color:#268bd2">stack</span>.<span style="color:#268bd2">topRunningActivityLocked</span>(<span style="color:#859900;font-weight:bold">null</span>);
                <span style="color:#859900">if</span> (<span style="color:#268bd2">hr</span> != <span style="color:#859900;font-weight:bold">null</span>) {
                    <span style="color:#859900">if</span> (<span style="color:#268bd2">hr</span>.<span style="color:#268bd2">app</span> == <span style="color:#859900;font-weight:bold">null</span> &amp;&amp; <span style="color:#268bd2">app</span>.<span style="color:#268bd2">uid</span> == <span style="color:#268bd2">hr</span>.<span style="color:#268bd2">info</span>.<span style="color:#268bd2">applicationInfo</span>.<span style="color:#268bd2">uid</span>
                            &amp;&amp; <span style="color:#268bd2">processName</span>.<span style="color:#268bd2">equals</span>(<span style="color:#268bd2">hr</span>.<span style="color:#268bd2">processName</span>)) {
                        <span style="color:#859900">try</span> {
                            <span style="color:#859900">if</span> (<span style="color:#268bd2">realStartActivityLocked</span>(<span style="color:#268bd2">hr</span>, <span style="color:#268bd2">app</span>, <span style="color:#859900;font-weight:bold">true</span>, <span style="color:#859900;font-weight:bold">true</span>)) {
                                <span style="color:#268bd2">didSomething</span> = <span style="color:#859900;font-weight:bold">true</span>;
                            }
                        } <span style="color:#859900">catch</span> (<span style="color:#268bd2">RemoteException</span> <span style="color:#268bd2">e</span>) {
                            <span style="color:#859900">throw</span> <span style="color:#268bd2">e</span>;
                        }
                    }
                }
            }
        }
        <span style="color:#859900">if</span> (!<span style="color:#268bd2">didSomething</span>) {
            <span style="color:#268bd2">ensureActivitiesVisibleLocked</span>(<span style="color:#859900;font-weight:bold">null</span>, <span style="color:#268bd2">0</span>);
        }
        <span style="color:#859900">return</span> <span style="color:#268bd2">didSomething</span>;
    }
</code></pre></div><p>遍历 ActivityStack 和 TaskRecord，找到位于 Activity 堆栈顶端的一个 ActivityRecord 对象 <code>hr</code>，接着检查这个 Activity 组件的用户 ID 和 进程名是否与 ProcessRecord 对象 app 所描述的应用程序的用户 ID 和进程名一致，如果一致，则调用 <code>realStartActivityLocked</code>方法来请求该应用程序进程启动一个 Activity 组件。</p>
<h3 id="stacksupervisor-类的-realstartactivitylocked-方法">StackSupervisor 类的 realStartActivityLocked() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">realStartActivityLocked</span>(<span style="color:#268bd2">ActivityRecord</span> <span style="color:#268bd2">r</span>,
            <span style="color:#268bd2">ProcessRecord</span> <span style="color:#268bd2">app</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">andResume</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">checkConfig</span>)
            <span style="color:#859900">throws</span> <span style="color:#268bd2">RemoteException</span> {

		<span style="color:#268bd2">r</span>.<span style="color:#268bd2">app</span> = <span style="color:#268bd2">app</span>;
        <span style="color:#268bd2">app</span>.<span style="color:#268bd2">waitingToKill</span> = <span style="color:#859900;font-weight:bold">null</span>;
        <span style="color:#268bd2">r</span>.<span style="color:#268bd2">launchCount</span>++;
        <span style="color:#268bd2">r</span>.<span style="color:#268bd2">lastLaunchTime</span> = <span style="color:#268bd2">SystemClock</span>.<span style="color:#268bd2">uptimeMillis</span>();
        
        <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">idx</span> = <span style="color:#268bd2">app</span>.<span style="color:#268bd2">activities</span>.<span style="color:#268bd2">indexOf</span>(<span style="color:#268bd2">r</span>);
        <span style="color:#859900">if</span> (<span style="color:#268bd2">idx</span> &lt; <span style="color:#268bd2">0</span>) {
            <span style="color:#268bd2">app</span>.<span style="color:#268bd2">activities</span>.<span style="color:#268bd2">add</span>(<span style="color:#268bd2">r</span>);
        }
        
	    <span style="color:#859900">try</span> {
		    <span style="color:#268bd2">app</span>.<span style="color:#268bd2">thread</span>.<span style="color:#268bd2">scheduleLaunchActivity</span>(<span style="color:#859900">new</span> <span style="color:#268bd2">Intent</span>(<span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>), <span style="color:#268bd2">r</span>.<span style="color:#268bd2">appToken</span>,
                    <span style="color:#268bd2">System</span>.<span style="color:#268bd2">identityHashCode</span>(<span style="color:#268bd2">r</span>), <span style="color:#268bd2">r</span>.<span style="color:#268bd2">info</span>, <span style="color:#859900">new</span> <span style="color:#268bd2">Configuration</span>(<span style="color:#268bd2">mService</span>.<span style="color:#268bd2">mConfiguration</span>),
                    <span style="color:#859900">new</span> <span style="color:#268bd2">Configuration</span>(<span style="color:#268bd2">stack</span>.<span style="color:#268bd2">mOverrideConfig</span>), <span style="color:#268bd2">r</span>.<span style="color:#268bd2">compat</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">launchedFromPackage</span>,
                    <span style="color:#268bd2">task</span>.<span style="color:#268bd2">voiceInteractor</span>, <span style="color:#268bd2">app</span>.<span style="color:#268bd2">repProcState</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">icicle</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">persistentState</span>, <span style="color:#268bd2">results</span>,
                    <span style="color:#268bd2">newIntents</span>, !<span style="color:#268bd2">andResume</span>, <span style="color:#268bd2">mService</span>.<span style="color:#268bd2">isNextTransitionForward</span>(), <span style="color:#268bd2">profilerInfo</span>);
        } <span style="color:#859900">catch</span> (<span style="color:#268bd2">RemoteException</span> <span style="color:#268bd2">e</span>) {
        }
        <span style="color:#859900">return</span> <span style="color:#859900;font-weight:bold">true</span>;
  }
<span style="color:#93a1a1;font-style:italic">// ApplicationThread 的 scheduleRelaunchActivity 方法
</span><span style="color:#93a1a1;font-style:italic"></span> <span style="color:#859900">public</span> <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">scheduleLaunchActivity</span>(<span style="color:#268bd2">Intent</span> <span style="color:#268bd2">intent</span>, <span style="color:#268bd2">IBinder</span> <span style="color:#268bd2">token</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">ident</span>,
                <span style="color:#268bd2">ActivityInfo</span> <span style="color:#268bd2">info</span>, <span style="color:#268bd2">Configuration</span> <span style="color:#268bd2">curConfig</span>, <span style="color:#268bd2">Configuration</span> <span style="color:#268bd2">overrideConfig</span>,
                <span style="color:#268bd2">CompatibilityInfo</span> <span style="color:#268bd2">compatInfo</span>, <span style="color:#268bd2">String</span> <span style="color:#268bd2">referrer</span>, <span style="color:#268bd2">IVoiceInteractor</span> <span style="color:#268bd2">voiceInteractor</span>,
                <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">procState</span>, <span style="color:#268bd2">Bundle</span> <span style="color:#268bd2">state</span>, <span style="color:#268bd2">PersistableBundle</span> <span style="color:#268bd2">persistentState</span>,
                <span style="color:#268bd2">List</span>&lt;<span style="color:#268bd2">ResultInfo</span>&gt; <span style="color:#268bd2">pendingResults</span>, <span style="color:#268bd2">List</span>&lt;<span style="color:#268bd2">ReferrerIntent</span>&gt; <span style="color:#268bd2">pendingNewIntents</span>,
                <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">notResumed</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">isForward</span>, <span style="color:#268bd2">ProfilerInfo</span> <span style="color:#268bd2">profilerInfo</span>) {

            <span style="color:#268bd2">updateProcessState</span>(<span style="color:#268bd2">procState</span>, <span style="color:#859900;font-weight:bold">false</span>);

            <span style="color:#268bd2">ActivityClientRecord</span> <span style="color:#268bd2">r</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">ActivityClientRecord</span>();

            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">token</span> = <span style="color:#268bd2">token</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">ident</span> = <span style="color:#268bd2">ident</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span> = <span style="color:#268bd2">intent</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">referrer</span> = <span style="color:#268bd2">referrer</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">voiceInteractor</span> = <span style="color:#268bd2">voiceInteractor</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">activityInfo</span> = <span style="color:#268bd2">info</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">compatInfo</span> = <span style="color:#268bd2">compatInfo</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span> = <span style="color:#268bd2">state</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">persistentState</span> = <span style="color:#268bd2">persistentState</span>;

            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">pendingResults</span> = <span style="color:#268bd2">pendingResults</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">pendingIntents</span> = <span style="color:#268bd2">pendingNewIntents</span>;

            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">startsNotResumed</span> = <span style="color:#268bd2">notResumed</span>;
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">isForward</span> = <span style="color:#268bd2">isForward</span>;

            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">profilerInfo</span> = <span style="color:#268bd2">profilerInfo</span>;

            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">overrideConfig</span> = <span style="color:#268bd2">overrideConfig</span>;
            <span style="color:#268bd2">updatePendingConfiguration</span>(<span style="color:#268bd2">curConfig</span>);
			<span style="color:#93a1a1;font-style:italic">// 向主线程发送消息
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#268bd2">sendMessage</span>(<span style="color:#268bd2">H</span>.<span style="color:#268bd2">LAUNCH_ACTIVITY</span>, <span style="color:#268bd2">r</span>);
        }
</code></pre></div><p>首先将参数 <code>r</code>的成员变量<code>app</code>的值设置为参数<code>app</code>，表示它描述的 Activity 组件是在参数 app 所描述的应用程序进程中启动的，接着将该 Activity 组件添加到参数 <code>app</code>所描述的应用程序进程的 Activity 组件列表中。</p>
<p>接下来调用<code>thread</code>的<code>scheduleLaunchActivity</code>方法来通知前面创建的应用程序进程启动由参数<code>r</code>所描述的一个 Activity 组件。</p>
<p>由于 <code>thread</code>的类型是 ApplicationThread，又是一个 Binder 对象，则又是跨进程的通信，此时的执行还是在 ActivityManagerService 进程内的。通过 ApplicationThread 跨进程向应用程序进程发送请求。</p>
<p>在主线程的消息循环中对应的响应方法为<code>handleLaunchActivity</code>。</p>
<h3 id="activitythread-类的-handlelaunchactivity-方法">ActivityThread 类的 handleLaunchActivity() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#859900">private</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">handleLaunchActivity</span>(<span style="color:#268bd2">ActivityClientRecord</span> <span style="color:#268bd2">r</span>, <span style="color:#268bd2">Intent</span> <span style="color:#268bd2">customIntent</span>) {

		 <span style="color:#93a1a1;font-style:italic">// Initialize before creating the activity
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#268bd2">WindowManagerGlobal</span>.<span style="color:#268bd2">initialize</span>();
        <span style="color:#268bd2">Activity</span> <span style="color:#268bd2">a</span> = <span style="color:#268bd2">performLaunchActivity</span>(<span style="color:#268bd2">r</span>, <span style="color:#268bd2">customIntent</span>);

		<span style="color:#859900">if</span> (<span style="color:#268bd2">a</span> != <span style="color:#859900;font-weight:bold">null</span>) {
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">createdConfig</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">Configuration</span>(<span style="color:#268bd2">mConfiguration</span>);
            <span style="color:#268bd2">Bundle</span> <span style="color:#268bd2">oldState</span> = <span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span>;
            <span style="color:#268bd2">handleResumeActivity</span>(<span style="color:#268bd2">r</span>.<span style="color:#268bd2">token</span>, <span style="color:#859900;font-weight:bold">false</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">isForward</span>,
                    !<span style="color:#268bd2">r</span>.<span style="color:#268bd2">activity</span>.<span style="color:#268bd2">mFinished</span> &amp;&amp; !<span style="color:#268bd2">r</span>.<span style="color:#268bd2">startsNotResumed</span>);
		} <span style="color:#859900">else</span> {
            <span style="color:#93a1a1;font-style:italic">// If there was an error, for any reason, tell the activity
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#93a1a1;font-style:italic">// manager to stop us.
</span><span style="color:#93a1a1;font-style:italic"></span>            <span style="color:#859900">try</span> {
                <span style="color:#268bd2">ActivityManagerNative</span>.<span style="color:#268bd2">getDefault</span>()
                    .<span style="color:#268bd2">finishActivity</span>(<span style="color:#268bd2">r</span>.<span style="color:#268bd2">token</span>, <span style="color:#268bd2">Activity</span>.<span style="color:#268bd2">RESULT_CANCELED</span>, <span style="color:#859900;font-weight:bold">null</span>, <span style="color:#859900;font-weight:bold">false</span>);
            } <span style="color:#859900">catch</span> (<span style="color:#268bd2">RemoteException</span> <span style="color:#268bd2">ex</span>) {
                <span style="color:#93a1a1;font-style:italic">// Ignore
</span><span style="color:#93a1a1;font-style:italic"></span>            }
        }
</code></pre></div><p>首先调用了<code>performLaunchActivity</code>将 Activity 组件启动起来，然后在调用 <code>handleResumeActivity</code>方法将 Activity 组件的状态设置为 <code>Resumed</code>。</p>
<h3 id="activitythread-类的-performlaunchactivity-方法">ActivityThread 类的 performLaunchActivity() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#859900">private</span> <span style="color:#268bd2">Activity</span> <span style="color:#268bd2">performLaunchActivity</span>(<span style="color:#268bd2">ActivityClientRecord</span> <span style="color:#268bd2">r</span>, <span style="color:#268bd2">Intent</span> <span style="color:#268bd2">customIntent</span>) {

	<span style="color:#268bd2">ComponentName</span> <span style="color:#268bd2">component</span> = <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>.<span style="color:#268bd2">getComponent</span>();
        <span style="color:#859900">if</span> (<span style="color:#268bd2">component</span> == <span style="color:#859900;font-weight:bold">null</span>) {
            <span style="color:#268bd2">component</span> = <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>.<span style="color:#268bd2">resolveActivity</span>(
                <span style="color:#268bd2">mInitialApplication</span>.<span style="color:#268bd2">getPackageManager</span>());
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>.<span style="color:#268bd2">setComponent</span>(<span style="color:#268bd2">component</span>);
        }
    <span style="color:#93a1a1;font-style:italic">// 通过反射 新建一个 Activity 对象
</span><span style="color:#93a1a1;font-style:italic"></span>	<span style="color:#268bd2">Activity</span> <span style="color:#268bd2">activity</span> = <span style="color:#859900;font-weight:bold">null</span>;
        <span style="color:#859900">try</span> {
            <span style="color:#268bd2">java</span>.<span style="color:#268bd2">lang</span>.<span style="color:#268bd2">ClassLoader</span> <span style="color:#268bd2">cl</span> = <span style="color:#268bd2">r</span>.<span style="color:#268bd2">packageInfo</span>.<span style="color:#268bd2">getClassLoader</span>();
            <span style="color:#268bd2">activity</span> = <span style="color:#268bd2">mInstrumentation</span>.<span style="color:#268bd2">newActivity</span>(
                    <span style="color:#268bd2">cl</span>, <span style="color:#268bd2">component</span>.<span style="color:#268bd2">getClassName</span>(), <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>);
            <span style="color:#268bd2">StrictMode</span>.<span style="color:#268bd2">incrementExpectedActivityCount</span>(<span style="color:#268bd2">activity</span>.<span style="color:#268bd2">getClass</span>());
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>.<span style="color:#268bd2">setExtrasClassLoader</span>(<span style="color:#268bd2">cl</span>);
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>.<span style="color:#268bd2">prepareToEnterProcess</span>();
            <span style="color:#859900">if</span> (<span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span> != <span style="color:#859900;font-weight:bold">null</span>) {
                <span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span>.<span style="color:#268bd2">setClassLoader</span>(<span style="color:#268bd2">cl</span>);
            }
        } <span style="color:#859900">catch</span> (<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>) {
        }

        <span style="color:#859900">try</span> {
            <span style="color:#268bd2">Application</span> <span style="color:#268bd2">app</span> = <span style="color:#268bd2">r</span>.<span style="color:#268bd2">packageInfo</span>.<span style="color:#268bd2">makeApplication</span>(<span style="color:#859900;font-weight:bold">false</span>, <span style="color:#268bd2">mInstrumentation</span>);
            <span style="color:#859900">if</span> (<span style="color:#268bd2">activity</span> != <span style="color:#859900;font-weight:bold">null</span>) {
	            <span style="color:#93a1a1;font-style:italic">// 创建 Context ，作为 Activity 的运行上下文环境
</span><span style="color:#93a1a1;font-style:italic"></span>                <span style="color:#268bd2">Context</span> <span style="color:#268bd2">appContext</span> = <span style="color:#268bd2">createBaseContextForActivity</span>(<span style="color:#268bd2">r</span>, <span style="color:#268bd2">activity</span>);
                <span style="color:#268bd2">CharSequence</span> <span style="color:#268bd2">title</span> = <span style="color:#268bd2">r</span>.<span style="color:#268bd2">activityInfo</span>.<span style="color:#268bd2">loadLabel</span>(<span style="color:#268bd2">appContext</span>.<span style="color:#268bd2">getPackageManager</span>());
                <span style="color:#268bd2">Configuration</span> <span style="color:#268bd2">config</span> = <span style="color:#859900">new</span> <span style="color:#268bd2">Configuration</span>(<span style="color:#268bd2">mCompatConfiguration</span>);
                
                <span style="color:#268bd2">activity</span>.<span style="color:#268bd2">attach</span>(<span style="color:#268bd2">appContext</span>, <span style="color:#859900">this</span>, <span style="color:#268bd2">getInstrumentation</span>(), <span style="color:#268bd2">r</span>.<span style="color:#268bd2">token</span>,
                        <span style="color:#268bd2">r</span>.<span style="color:#268bd2">ident</span>, <span style="color:#268bd2">app</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">intent</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">activityInfo</span>, <span style="color:#268bd2">title</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">parent</span>,
                        <span style="color:#268bd2">r</span>.<span style="color:#268bd2">embeddedID</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">lastNonConfigurationInstances</span>, <span style="color:#268bd2">config</span>,
                        <span style="color:#268bd2">r</span>.<span style="color:#268bd2">referrer</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">voiceInteractor</span>);
                        
                <span style="color:#859900">if</span> (<span style="color:#268bd2">r</span>.<span style="color:#268bd2">isPersistable</span>()) { <span style="color:#93a1a1;font-style:italic">// 回调 Activity 的 onCreate 函数
</span><span style="color:#93a1a1;font-style:italic"></span>                    <span style="color:#268bd2">mInstrumentation</span>.<span style="color:#268bd2">callActivityOnCreate</span>(<span style="color:#268bd2">activity</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">persistentState</span>);
                } <span style="color:#859900">else</span> {
                    <span style="color:#268bd2">mInstrumentation</span>.<span style="color:#268bd2">callActivityOnCreate</span>(<span style="color:#268bd2">activity</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span>);
                }
              
                <span style="color:#268bd2">r</span>.<span style="color:#268bd2">activity</span> = <span style="color:#268bd2">activity</span>;
                <span style="color:#268bd2">r</span>.<span style="color:#268bd2">stopped</span> = <span style="color:#859900;font-weight:bold">true</span>;
                <span style="color:#859900">if</span> (!<span style="color:#268bd2">r</span>.<span style="color:#268bd2">activity</span>.<span style="color:#268bd2">mFinished</span>) { <span style="color:#93a1a1;font-style:italic">// 回调 Activity 的 onStart 函数
</span><span style="color:#93a1a1;font-style:italic"></span>                    <span style="color:#268bd2">activity</span>.<span style="color:#268bd2">performStart</span>();
                    <span style="color:#268bd2">r</span>.<span style="color:#268bd2">stopped</span> = <span style="color:#859900;font-weight:bold">false</span>;
                }
                <span style="color:#859900">if</span> (!<span style="color:#268bd2">r</span>.<span style="color:#268bd2">activity</span>.<span style="color:#268bd2">mFinished</span>) { <span style="color:#93a1a1;font-style:italic">// Activity 的 onRestoreInstanceState 函数
</span><span style="color:#93a1a1;font-style:italic"></span>                    <span style="color:#859900">if</span> (<span style="color:#268bd2">r</span>.<span style="color:#268bd2">isPersistable</span>()) {
                        <span style="color:#859900">if</span> (<span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span> != <span style="color:#859900;font-weight:bold">null</span> || <span style="color:#268bd2">r</span>.<span style="color:#268bd2">persistentState</span> != <span style="color:#859900;font-weight:bold">null</span>) {
                            <span style="color:#268bd2">mInstrumentation</span>.<span style="color:#268bd2">callActivityOnRestoreInstanceState</span>(<span style="color:#268bd2">activity</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span>,
                                    <span style="color:#268bd2">r</span>.<span style="color:#268bd2">persistentState</span>);
                        }
                    } <span style="color:#859900">else</span> <span style="color:#859900">if</span> (<span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span> != <span style="color:#859900;font-weight:bold">null</span>) {
                        <span style="color:#268bd2">mInstrumentation</span>.<span style="color:#268bd2">callActivityOnRestoreInstanceState</span>(<span style="color:#268bd2">activity</span>, <span style="color:#268bd2">r</span>.<span style="color:#268bd2">state</span>);
                    }
                }
              
            }
            <span style="color:#268bd2">r</span>.<span style="color:#268bd2">paused</span> = <span style="color:#859900;font-weight:bold">true</span>;
            <span style="color:#268bd2">mActivities</span>.<span style="color:#268bd2">put</span>(<span style="color:#268bd2">r</span>.<span style="color:#268bd2">token</span>, <span style="color:#268bd2">r</span>);
        } <span style="color:#859900">catch</span> (<span style="color:#268bd2">SuperNotCalledException</span> <span style="color:#268bd2">e</span>) {
            <span style="color:#859900">throw</span> <span style="color:#268bd2">e</span>;
        } <span style="color:#859900">catch</span> (<span style="color:#268bd2">Exception</span> <span style="color:#268bd2">e</span>) {
        }
}
</code></pre></div><p>首先获得要启动的 Activity 组件的包名和类名，它们使用一个<code>ComponentName</code>对象 component 来描述。</p>
<p>接着通过反射创建一个 Activity 类实例。然后，初始化了一个 Context 对象，作为前面创建的 Android 类实例的运行环境上下文，通过它就能访问特定的应用程序资源，再调用 <code>attach</code>方法，初始化 Activity 相关信息。</p>
<p>再调用<code>Instrumentation</code>类的<code>callActivityOnCreate</code>方法将 Activity 启动起来，此时，Activity 的 onCreate 方法就会被调用了，接下来就是调用 <code>performStart</code>方法，方法内部调用<code>Instrumentation</code>类的<code>callActivityOnStart</code>方法调用 Activity 的 onStart 方法。此时，Activity 的 onCreate 和 onStart 两大方法都调用了。</p>
<p>接下来就是执行<code>handleResumeActivity</code>方法将 Activity 组件的状态设置为 <code>Resumed</code>。</p>
<h3 id="activitythread-类的-handleresumeactivity-方法">ActivityThread 类的 handleResumeActivity() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#859900">final</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">handleResumeActivity</span>(<span style="color:#268bd2">IBinder</span> <span style="color:#268bd2">token</span>,
            <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">clearHide</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">isForward</span>, <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">reallyResume</span>) {

	 <span style="color:#93a1a1;font-style:italic">// TODO Push resumeArgs into the activity for consideration
</span><span style="color:#93a1a1;font-style:italic"></span>	 <span style="color:#93a1a1;font-style:italic">// 真正执行的是 performResumeActivity 方法
</span><span style="color:#93a1a1;font-style:italic"></span>        <span style="color:#268bd2">ActivityClientRecord</span> <span style="color:#268bd2">r</span> = <span style="color:#268bd2">performResumeActivity</span>(<span style="color:#268bd2">token</span>, <span style="color:#268bd2">clearHide</span>);
        <span style="color:#859900">if</span> (<span style="color:#268bd2">r</span> != <span style="color:#859900;font-weight:bold">null</span>) {
	        <span style="color:#93a1a1;font-style:italic">// 省略和 Window 相关代码
</span><span style="color:#93a1a1;font-style:italic"></span>        } <span style="color:#859900">else</span> {
	        <span style="color:#859900">try</span> {
                <span style="color:#268bd2">ActivityManagerNative</span>.<span style="color:#268bd2">getDefault</span>()
                    .<span style="color:#268bd2">finishActivity</span>(<span style="color:#268bd2">token</span>, <span style="color:#268bd2">Activity</span>.<span style="color:#268bd2">RESULT_CANCELED</span>, <span style="color:#859900;font-weight:bold">null</span>, <span style="color:#859900;font-weight:bold">false</span>);
            } <span style="color:#859900">catch</span> (<span style="color:#268bd2">RemoteException</span> <span style="color:#268bd2">ex</span>) {
            }
        }
}
</code></pre></div><p>真正执行的是 <code>performResumeActivity</code>方法。</p>
<h3 id="activitythread-类的-performresumeactivity-方法">ActivityThread 类的 performResumeActivity() 方法</h3>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#859900">public</span> <span style="color:#859900">final</span> <span style="color:#268bd2">ActivityClientRecord</span> <span style="color:#268bd2">performResumeActivity</span>(<span style="color:#268bd2">IBinder</span> <span style="color:#268bd2">token</span>,
            <span style="color:#859900;font-weight:bold">boolean</span> <span style="color:#268bd2">clearHide</span>) {
             <span style="color:#268bd2">ActivityClientRecord</span> <span style="color:#268bd2">r</span> = <span style="color:#268bd2">mActivities</span>.<span style="color:#268bd2">get</span>(<span style="color:#268bd2">token</span>);
             <span style="color:#859900">if</span> (<span style="color:#268bd2">r</span> != <span style="color:#859900;font-weight:bold">null</span> &amp;&amp; !<span style="color:#268bd2">r</span>.<span style="color:#268bd2">activity</span>.<span style="color:#268bd2">mFinished</span>) {
	             <span style="color:#268bd2">r</span>.<span style="color:#268bd2">activity</span>.<span style="color:#268bd2">performResume</span>();
	         }
	         <span style="color:#859900">return</span> <span style="color:#268bd2">r</span> ;
	}
</code></pre></div><p>最后，<code>performResume</code>方法还是调用的<code>Instrumentation</code>类的 <code>callActivityOnResume</code>方法，让当前 Activity 组件进入了 <code>Resumed</code>状态。</p>
<p>至此，从 Launcher 组件启动 Activity 过程源码分析就算是过了一遍了，里面还有许多细节之处，等待日后挖掘。</p>
<h2 id="参考">参考</h2>
<ol>
<li>Android 6.0 源码</li>
<li>《Android 系统源代码情景分析》</li>
<li><a href="http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1">http://duanqz.github.io/2016-07-29-Activity-LaunchProcess-Part1</a></li>
</ol>


          <h2>微信公众号</h2>

<p>扫描下面的二维码关注我的微信公众帐号</p>

<p>添加我的微信 ezglumes 拉你入群一起交流学习~</p>

<img src="https://image.glumes.com/blog_image/wexin-logo.png" alt="wechat-account-qrcode">


  


                    <p>
                      原创文章，转载请注明来源: &nbsp;&nbsp; <a href="https://glumes.com/post/android/android-start-activity-from-launcher-3/">Android 6.0 Launcher 启动 Activity 过程源码分析（三）</a>
                    </p>


          

          
            <div class="social-share" data-initialized="true" style="margin-bottom: 20px;margin-top:20px;">
    <center>
    <a href="#" class="social-share-icon icon-weibo"></a>
    <a href="#" class="social-share-icon icon-wechat"></a>
    <a href="#" class="social-share-icon icon-twitter"></a>
    <a href="#" class="social-share-icon icon-linkedin"></a>
    <a href="#" class="social-share-icon icon-facebook"></a>
    <a href="#" class="social-share-icon icon-qq"></a>
    <a href="#" class="social-share-icon icon-qzone"></a>
    </center>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

          
        </article>
  
        
          

<h3>相关文章</h3>
<ul style="margin-bottom: 25px;">
    
    <li><a href="https://glumes.com/post/android/android-start-activity-from-launcher-2/">Android 6.0 Launcher 启动 Activity 过程源码分析（二）</a></li>
    
    <li><a href="https://glumes.com/post/android/android-start-activity-from-launcher-1/">Android 6.0 Launcher 启动 Activity 过程源码分析（一）</a></li>
    
    <li><a href="https://glumes.com/post/android/rxjava-wrapper-callback/">用 RxJava 封装回调方法 CallBack</a></li>
    
    <li><a href="https://glumes.com/post/android/android-hal-summary/">Android 硬件抽象层调用流程小结</a></li>
    
    <li><a href="https://glumes.com/post/android/kotlin-functional-programming-whth-anko/">Kotlin 函数式编程与 Anko 构建布局实现原理分析</a></li>
    
    <li><a href="https://glumes.com/post/android/kotlin-with-anko/">Kotlin 使用 Anko 布局那些事</a></li>
    
</ul>

        
  
        
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://glumes.com/post/android/android-start-activity-from-launcher-2/" data-toggle="tooltip" data-placement="top" title="Android 6.0 Launcher 启动 Activity 过程源码分析（二）">&larr; 前一篇</a>
            </li>
          
          
            <li class="next">
              <a href="https://glumes.com/post/android/android-start-activity-from-launcher-4/" data-toggle="tooltip" data-placement="top" title=" Android 6.0 Launcher 启动 Activity 过程分析小结（四）">后一篇 &rarr;</a>
            </li>
          
        </ul>
        

        
        
        

        <script data-ad-client="ca-pub-4260372210024819" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        

        
  
    <div class="comments">
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "glumes" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  


        
          

        
  
      </div>
    
    
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">

          
          
          
              <li>
                <a href="mailto:zhaoying9402@outlook.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://github.com/glumes" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://weibo.com/u/3157458295" title="微博">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;
          2020

          
            &nbsp;&bull;&nbsp;
            <a href="https://glumes.com/">音视频开发进阶</a>
            &nbsp;&bull;&nbsp;
            <a href="https://glumes.com/sitemap.xml">网站地图</a>
          
             &nbsp;&bull;&nbsp;
                      <a href="http://beian.miit.gov.cn">粤ICP备20067247号</a>
        </p>






                <p class="text-center text-muted">
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
          <span id="busuanzi_container_site_pv" style="display:none">
            本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          &nbsp;&bull;&nbsp;
          <span id="busuanzi_container_site_uv" style="display:none">
            访客数<span id="busuanzi_value_site_uv"></span>人次
          </span>
          &nbsp;&bull;&nbsp;
                 <span id="busuanzi_container_page_pv" style="display:none">
            阅读量<span id="busuanzi_value_page_pv"></span>人次
          </span>
        </p>

<p>
<a target="_blank"; href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral";>
<img style="height:20px;width:auto;"; src="https://www.upyun.com/static/img/%E6%A0%B7%E5%BC%8F%E5%9B%BE.7cf927c.png"; />
</a>
</P>
        
        <p class="credits theme-by text-muted">
          由 <a href="http://gohugo.io">Hugo v0.74.3</a> 强力驱动 &nbsp;&bull;&nbsp; 主题 <a href="https://github.com/cnych/qikqiak.com">qikqiak-blog</a> 移植自 <a href="https://github.com/rootsongjc/beautifulhugo">Beautiful Hugo</a>
          
        </p>

      </div>
    </div>
  </div>
</footer>


<script src="https://glumes.com/js/jquery-1.11.2.min.js"></script>
<script src="https://glumes.com/js/bootstrap.min.js"></script>
<script src="https://glumes.com/js/main.min.js"></script>
<script src="https://glumes.com/js/reward.js"></script>










<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>







  






<script src='https://glumes.com/js/bundle.min.dd00fc477b5e611b3b15869e7f4ffa218efd3a1b6f00902db8b25e1e9a1d90fc.js' integrity='sha256-3QD8R3teYRs7FYaef0/6IY79OhtvAJAtuLJeHpodkPw='></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery-migrate@1.2.1/dist/jquery-migrate.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script type="text/javascript">
$('.carousel').slick({
    dots: true,
    arrows: true,
    autoplay: true,
    autoplaySpeed: 4000,
    infinite: true,
    speed: 500,
    fade: true,
    cssEase: 'linear',
    centerMode: true,
    prevArrow: '<button type="button" class="slick-prev"></button>',
    nextArrow: '<button type="button" class="slick-next"></button>',
});
</script>

  </body>
</html>

