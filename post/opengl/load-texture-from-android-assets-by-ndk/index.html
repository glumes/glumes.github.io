<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">


  <title>Android NDK 开发 —— 从 Assets 文件夹加载图片并上传纹理</title>
  <meta property="og:title" content="Android NDK 开发 —— 从 Assets 文件夹加载图片并上传纹理" />
  <meta name="twitter:title" content="Android NDK 开发 —— 从 Assets 文件夹加载图片并上传纹理" />

  <meta name="description" content="在 OpenGL 开发中，我们要渲染一张图片，通常先是得到一张图片对应的 Bitmap ,然后将该 Bitmap 作为纹理上传到 OpenGL 中。在 Android 中有封装好的 GLUtils 类的 texImage2D 方法供我们调用。
    public static void texImage2D(int target, int level, int internalformat,
            Bitmap bitmap, int type, int border)
该方法的底层原理实际上也是解析了该 Bitmap ，得到了 Bitmap 所有的像素数据，类似于 Android NDK 关于 Bitmap 操作的 AndroidBitmap_lockPixels 方法，如果你不太了解该方法，可以参考这篇文章：Android JNI 之 Bitmap 操作。
得到了所有像素数据之后，实际最终还是调用了 OpenGL 的 glTexImage2D 来实现纹理上传。当然，如果可以直接得到所有数据，也不需要走解析 Bitmap 这一步了，这种场景最常见的就是把相机作为输入了。">
  <meta property="og:description" content="在 OpenGL 开发中，我们要渲染一张图片，通常先是得到一张图片对应的 Bitmap ,然后将该 Bitmap 作为纹理上传到 OpenGL 中。在 Android 中有封装好的 GLUtils 类的 texImage2D 方法供我们调用。
    public static void texImage2D(int target, int level, int internalformat,
            Bitmap bitmap, int type, int border)
该方法的底层原理实际上也是解析了该 Bitmap ，得到了 Bitmap 所有的像素数据，类似于 Android NDK 关于 Bitmap 操作的 AndroidBitmap_lockPixels 方法，如果你不太了解该方法，可以参考这篇文章：Android JNI 之 Bitmap 操作。
得到了所有像素数据之后，实际最终还是调用了 OpenGL 的 glTexImage2D 来实现纹理上传。当然，如果可以直接得到所有数据，也不需要走解析 Bitmap 这一步了，这种场景最常见的就是把相机作为输入了。">
  <meta name="twitter:description" content="在 OpenGL 开发中，我们要渲染一张图片，通常先是得到一张图片对应的 Bitmap ,然后将该 Bitmap 作为纹理上传到 OpenGL 中。在 Android 中有封装好的 GLUtils 类的 texImage2D 方法供我们调用。
    public static void texImage2D(int target, int level, int internalformat, …">
  <meta name="author" content=""/>
  <meta name="referrer" content="origin" />
  <meta name="twitter:card" content="summary" />
  <meta property="og:url" content="https://glumes.com/post/opengl/load-texture-from-android-assets-by-ndk/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="星陨的博客" />

  <meta name="generator" content="Hugo 0.74.3" />
  <link rel="canonical" href="https://glumes.com/post/opengl/load-texture-from-android-assets-by-ndk/" />
  <link rel="alternate" href="https://glumes.com/index.xml" type="application/rss+xml" title="星陨的博客">
  <link rel="stylesheet" href="https://glumes.com/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://glumes.com/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://glumes.com/css/main.css?t=126" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://glumes.com/css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://glumes.com/css/highlight.min.css" />
  <link rel="stylesheet" href="https://glumes.com/css/prism.css?t=123" />
  <link rel="stylesheet" href="https://glumes.com/css/search.css" />
  

<link rel="stylesheet" href="https://res.cloudinary.com/glumes-com/raw/upload/v1516330613/website/css/prism.css" />






<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-84590324-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "https://hm.baidu.com/hm.js?9276c0ce2d3c49b591323abab4a32e1e";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
</script>



</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://glumes.com/">星陨的博客</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">目录</a>
              <div class="navlinks-children">
                
                  <a href="https://glumes.com/categories/android">Android</a>
                
                  <a href="https://glumes.com/categories/opencv">opencv</a>
                
                  <a href="https://glumes.com/categories/opengl">opengl</a>
                
                  <a href="https://glumes.com/categories/%e9%9f%b3%e8%a7%86%e9%a2%91%e5%bc%80%e5%8f%91">ffmpeg</a>
                
                  <a href="https://glumes.com/categories/python">python</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="生活" href="https://glumes.com/categories/life">生活</a>
            </li>
          
        
          
            <li>
              <a title="标签" href="https://glumes.com/tags">标签</a>
            </li>
          
        
          
            <li>
              <a title="关于" href="https://glumes.com/about/">关于</a>
            </li>
          
        
          
            <li>
              <a title="文章集" href="https://glumes.com/post/">文章集</a>
            </li>
          
        

        

        

        

      </ul>
    </div>

  </div>
</nav>





    
  
  
  




  
    <div id="header-big-imgs" data-num-img=1 data-img-src-1="https://image.glumes.com/images/2019/05/14/aerial-view-architectural-design-buildings-2228123.jpg" ></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        
        <div class="container">
          <div class="row">
              <div class="col-lg-12 col-md-12 col-md-offset-0">
                
                <div class="page-heading">
                
                  
                     <h1>Android NDK 开发 —— 从 Assets 文件夹加载图片并上传纹理</h1>
                     
                    <span class="post-meta">
  Posted on May 14, 2019
  
</span>


                    
                  
                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-md-offset-0">
            <div class="post-heading">
                <h1 align="center">Android NDK 开发 —— 从 Assets 文件夹加载图片并上传纹理</h1>
                
                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">



        
      <div>
          
          
          <h5 id="tags" style="margin-top: 0px;">标签:
            
                <a href="https://glumes.com/tags/jni/">JNI</a> &nbsp;
            
          </h5>
          
      </div>

      <article role="main" class="blog-post" itemprop="articleBody" id="content">
        
          
        
        <p>在 OpenGL 开发中，我们要渲染一张图片，通常先是得到一张图片对应的 Bitmap ,然后将该 Bitmap 作为纹理上传到 OpenGL 中。在 Android 中有封装好的 <code>GLUtils</code> 类的 <code>texImage2D</code> 方法供我们调用。</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#859900">public</span> <span style="color:#859900">static</span> <span style="color:#859900;font-weight:bold">void</span> <span style="color:#268bd2">texImage2D</span>(<span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">target</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">level</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">internalformat</span>,
            <span style="color:#268bd2">Bitmap</span> <span style="color:#268bd2">bitmap</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">type</span>, <span style="color:#859900;font-weight:bold">int</span> <span style="color:#268bd2">border</span>)
</code></pre></div><p>该方法的底层原理实际上也是解析了该 Bitmap ，得到了 Bitmap 所有的像素数据，类似于 Android NDK 关于 Bitmap 操作的 <code>AndroidBitmap_lockPixels</code> 方法，如果你不太了解该方法，可以参考这篇文章：<a href="https://glumes.com/post/android/android-jni-bitmap-operation/">Android JNI 之 Bitmap 操作</a>。</p>
<p>得到了所有像素数据之后，实际最终还是调用了 OpenGL 的 <code>glTexImage2D</code> 来实现纹理上传。当然，如果可以直接得到所有数据，也不需要走解析 Bitmap 这一步了，这种场景最常见的就是把相机作为输入了。</p>
<p>接下来我们会通过 Android NDK 开发中去渲染一张图片，步骤还是如上，从图像解析到纹理上传，不同的是我们将会解析 Assets 文件夹中的图片，而不是一张已经保存在手机 SDCard 上的图片。</p>
<p>相比于前者，SDCard 上的图片已经有了绝对地址了，直接把地址传到 <code>stb_image</code> 库就可以完成解析了（参考之前的文章 <a href=""></a>），而 <code>Assets</code> 文件夹的内容在手机上可没有绝对地址哦，不信你仔细回想，可曾在看到过 APK 安装后 Assets 文件夹对应的内容？</p>
<p>一开始陷入了误区，想着怎么去获得文件的绝对地址，看到了 AssetManager 的 AAsset_openFileDescriptor 方法以为拿到文件描述符就万事大吉了，结果打印的地址是这样的 <code>/proc/9941/fd/79</code> ，这基本的不可用了。</p>
<p>换个思路，在 Java 中去加载 Assets 目录下的图片：</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">InputStream</span> <span style="color:#268bd2">is</span> = <span style="color:#268bd2">getAssets</span>().<span style="color:#268bd2">open</span>(<span style="color:#268bd2">fileName</span>); 
</code></pre></div><p>通过 AssertManager 的 open 方法直接拿到文件的输入流了。</p>
<p>而在 NDK 开发中同样的方式是行不通的，这里要采用另外一种方式，但其实意思都差不多的：</p>
<div class="highlight"><pre style="color:#586e75;background-color:#eee8d5;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">    <span style="color:#93a1a1;font-style:italic">// NDK 中是 AssetManager
</span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#268bd2">AAssetManager</span> *<span style="color:#268bd2">mgr</span> = <span style="color:#268bd2">AAssetManager_fromJava</span>(<span style="color:#268bd2">env</span>, <span style="color:#268bd2">assetManager</span>);
    <span style="color:#93a1a1;font-style:italic">// 打开 Asset 文件夹下的文件
</span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#268bd2">AAsset</span> *<span style="color:#268bd2">pathAsset</span> = <span style="color:#268bd2">AAssetManager_open</span>(<span style="color:#268bd2">mgr</span>, <span style="color:#268bd2">assetPath</span>, <span style="color:#268bd2">AASSET_MODE_UNKNOWN</span>);
    <span style="color:#93a1a1;font-style:italic">// 得到文件的长度
</span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#268bd2">off_t</span> <span style="color:#268bd2">assetLength</span> = <span style="color:#268bd2">AAsset_getLength</span>(<span style="color:#268bd2">pathAsset</span>);
    <span style="color:#93a1a1;font-style:italic">// 得到文件对应的 Buffer
</span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#859900;font-weight:bold">unsigned</span> <span style="color:#859900;font-weight:bold">char</span> *<span style="color:#268bd2">fileData</span> = (<span style="color:#859900;font-weight:bold">unsigned</span> <span style="color:#859900;font-weight:bold">char</span> *) <span style="color:#268bd2">AAsset_getBuffer</span>(<span style="color:#268bd2">pathAsset</span>);
    <span style="color:#93a1a1;font-style:italic">// stb_image 的方法，从内存中加载图片
</span><span style="color:#93a1a1;font-style:italic"></span>    <span style="color:#859900;font-weight:bold">unsigned</span> <span style="color:#859900;font-weight:bold">char</span> *<span style="color:#268bd2">contnet</span> = <span style="color:#268bd2">stbi_load_from_memory</span>(<span style="color:#268bd2">fileData</span>, <span style="color:#268bd2">assetLength</span>, &amp;<span style="color:#268bd2">w</span>, &amp;<span style="color:#268bd2">h</span>, &amp;<span style="color:#268bd2">n</span>, <span style="color:#2aa198;font-weight:bold">0</span>);
</code></pre></div><p>NDK 中可拿不到像 Java 那样的输入流，但是可以通过 AssetManager 的 AAsset_getBuffer 或者是 AAsset_read 方法去获取文件内容。</p>
<p>看到上面那两个 API 基本就稳了，再配合 <code>stb_image</code> 介绍过的方法，<code>stbi_load_from_memory</code> 从内存中加载图片的像素数据，最后就是 glTexImage2D 方法实现纹理上传。</p>
<p>具体的代码实践参考项目：</p>
<blockquote>
<p><a href="https://github.com/glumes/InstantGLSL">https://github.com/glumes/InstantGLSL</a></p>
</blockquote>
        


                

                  <h4>欢迎扫码关注微信公众号：【音视频开发进阶】，获得最新文章推送~~~</h4>

                  <h4>技术问题欢迎加我微信 ezglumes ，拉你进群交流~~~</h4>
                  
                  <br/>

                  <img src="https://glumes2blog.oss-cn-shenzhen.aliyuncs.com/wexin-public.png">

                  <br/>

                


                

                原创文章，转载请注明来源: &nbsp;&nbsp; <a href="https://glumes.com/post/opengl/load-texture-from-android-assets-by-ndk/">Android NDK 开发 —— 从 Assets 文件夹加载图片并上传纹理</a>

                

                


        
        
        
      </article>

      
        

<h3>相关文章</h3>
<ul style="margin-bottom: 25px;">
    
    <li><a href="https://glumes.com/post/android/android-jni-bitmap-operation/">Android JNI 之 Bitmap 操作</a></li>
    
    <li><a href="https://glumes.com/post/android/android-jni-thread-operation/">Android JNI 中的线程操作</a></li>
    
    <li><a href="https://glumes.com/post/android/android-jni-exception-handle/">Android JNI 调用时的异常处理</a></li>
    
    <li><a href="https://glumes.com/post/android/android-jni-reference-manage-rules/">Android JNI 中的引用管理</a></li>
    
    <li><a href="https://glumes.com/post/android/android-jni-cache-fieldid-and-methodid/">Android  JNI 调用时缓存字段和方法 ID</a></li>
    
    <li><a href="https://glumes.com/post/android/android-jni-invoke-constructor-method-and-super-method/">Android 通过 JNI 调用 Java 类的构造方法和父类的方法</a></li>
    
    <li><a href="https://glumes.com/post/android/android-jni-access-field-and-method/">Android 通过 JNI 访问 Java 字段和方法调用</a></li>
    
    <li><a href="https://glumes.com/post/android/android-jni-array-operation/">Android JNI 数组 操作</a></li>
    
    <li><a href="https://glumes.com/post/android/android-jni-basic-operation/">Android JNI 基本操作 </a></li>
    
</ul>

      

      
      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://glumes.com/post/android/stb-image-introduce/" data-toggle="tooltip" data-placement="top" title="简单易用的图像解码库介绍 —— stb_image">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="https://glumes.com/post/android/rust-compile-so-library/" data-toggle="tooltip" data-placement="top" title="rust 开发编译 Android 动态库实践">Next Post &rarr;</a>
          </li>
        
      </ul>
      

      
        
      





    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">

          
          
          
              <li>
                <a href="mailto:zhaoying9402@outlook.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://github.com/glumes" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
              <li>
                <a href="https://weibo.com/u/3157458295" title="微博">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          
        </ul>
        <p class="credits copyright text-muted">
          

          &nbsp;&bull;&nbsp;
          2020

          
            &nbsp;&bull;&nbsp;
            <a href="https://glumes.com/">星陨的博客</a>
            &nbsp;&bull;&nbsp;
            <a href="https://glumes.com/sitemap.xml">网站地图</a>
          
        </p>



       <p class="credits copyright text-muted">
            <a href="http://beian.miit.gov.cn">粤ICP备20067247号</a>
       </p>



                <p class="text-center text-muted">
          <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
          <span id="busuanzi_container_site_pv" style="display:none">
            本站总访问量<span id="busuanzi_value_site_pv"></span>次
          </span>
          &nbsp;&bull;&nbsp;
          <span id="busuanzi_container_site_uv" style="display:none">
            访客数<span id="busuanzi_value_site_uv"></span>人次
          </span>
          &nbsp;&bull;&nbsp;
                 <span id="busuanzi_container_page_pv" style="display:none">
            阅读量<span id="busuanzi_value_page_pv"></span>人次
          </span>
        </p>

        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.74.3</a> powered &nbsp;&bull;&nbsp; Theme by <a href="https://github.com/rootsongjc/beautifulhugo">Beautiful Hugo</a> adapted to <a href="https://github.com/glumes/glumes.com">glumes-blog</a>
          
        </p>

      </div>
    </div>
  </div>
</footer>


<script src="https://glumes.com/js/jquery-1.11.2.min.js"></script>
<script src="https://glumes.com/js/bootstrap.min.js"></script>
<script src="https://glumes.com/js/main.min.js"></script>
<script src="https://glumes.com/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script src="https://glumes.com/js/prism.js?t=123"></script>





<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
});
</script>







  





  </body>
</html>

